<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Issue Tracker ‚Äî Castles Technology</title>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:       #ffffff;
  --navy-mid:   #cc0000;
  --navy-light: #e60000;
  --steel:      #ffcccc;
  --accent:     #cc0000;
  --accent-dim: #aa0000;
  --sky:        #cc0000;
  --danger:     #990000;
  --success:    #2e9e6b;
  --warn:       #e07b20;
  --info:       #cc0000;
  --text-bright:#1a1a1a;
  --text-main:  #333333;
  --text-dim:   #888888;
  --border:     rgba(204,0,0,0.15);
  --card-bg:    rgba(255,255,255,0.98);
  --glass:      rgba(255,255,255,0.97);
  --sidebar-w:  240px;
  --topbar-h:   60px;
  --radius:     10px;
  --radius-lg:  14px;
}

html { font-size: 14px; scroll-behavior: smooth; }
body {
  font-family: 'Raleway', sans-serif;
  background: #f5f5f5;
  color: var(--text-main);
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--steel); border-radius: 99px; }

/* ===== SIDEBAR ===== */
#sidebar {
  width: var(--sidebar-w);
  min-height: 100vh;
  background: var(--navy-mid);
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0; top: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
}
.sidebar-logo {
  padding: 22px 20px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}
.logo-mark { display: flex; align-items: center; gap: 10px; }
.logo-text { font-size: 14px; font-weight: 700; color: #ffffff; line-height: 1.2; }
.logo-sub  { font-size: 10px; color: rgba(255,255,255,0.75); letter-spacing: 0.08em; text-transform: uppercase; font-family: 'Roboto Mono', monospace; }
.sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 9.5px; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.6); font-family: 'Roboto Mono', monospace; padding: 12px 8px 6px; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 12px; border-radius: 8px; cursor: pointer;
  transition: all 0.2s; color: rgba(255,255,255,0.85);
  font-size: 13.5px; font-weight: 500; user-select: none; text-decoration: none;
}
.nav-item:hover { background: rgba(255,255,255,0.15); color: #ffffff; }
.nav-item.active { background: rgba(255,255,255,0.2); color: #ffffff; border-left: 3px solid #ffffff; padding-left: 9px; }
.nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
.nav-badge { margin-left: auto; background: var(--danger); color: #fff; font-size: 10px; padding: 1px 6px; border-radius: 99px; font-family: 'Roboto Mono', monospace; }
.sidebar-footer { padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 11px; color: rgba(255,255,255,0.6); font-family: 'Roboto Mono', monospace; }

/* ===== MAIN ===== */
#main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
#topbar {
  height: var(--topbar-h); background: var(--glass); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border); display: flex; align-items: center;
  padding: 0 24px; gap: 16px; position: sticky; top: 0; z-index: 90; width: 100%;
}
.topbar-title { font-size: 15px; font-weight: 600; color: var(--text-bright); }
.topbar-sep { flex: 1; }
.topbar-search { display: flex; align-items: center; gap: 8px; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; padding: 6px 14px; width: 220px; }
.topbar-search input { background: transparent; border: none; outline: none; color: var(--text-main); font-family: 'Raleway', sans-serif; font-size: 13px; width: 100%; }
.topbar-search input::placeholder { color: var(--text-dim); }
.topbar-btn { display: flex; align-items: center; gap: 7px; background: var(--accent); color: #fff; font-weight: 700; font-size: 12.5px; border: none; border-radius: 8px; padding: 7px 16px; cursor: pointer; transition: background 0.2s; font-family: 'Raleway', sans-serif; }
.topbar-btn:hover { background: var(--accent-dim); }

/* ===== CONTENT ===== */
#content { flex: 1; padding: 28px; display: flex; flex-direction: column; gap: 24px; }
.view { display: none; flex-direction: column; gap: 24px; }
.view.active { display: flex; }

/* ===== STAT CARDS ===== */
.stat-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; }
.stat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px 20px; position: relative; overflow: hidden; transition: border-color 0.2s, transform 0.2s; }
.stat-card:hover { transform: translateY(-2px); }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; }
.stat-card.c-total::before { background: var(--sky); }
.stat-card.c-new::before   { background: var(--info); }
.stat-card.c-bug::before   { background: var(--danger); }
.stat-card.c-open::before  { background: var(--warn); }
.stat-card.c-prog::before  { background: var(--accent); }
.stat-card.c-res::before   { background: var(--success); }
.stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); font-family: 'Roboto Mono', monospace; margin-bottom: 6px; }
.stat-value { font-size: 30px; font-weight: 700; color: var(--text-bright); line-height: 1; }
.stat-icon  { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 28px; opacity: 0.12; }

/* ===== CARDS ===== */
.card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
.card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.card-title { font-size: 13px; font-weight: 600; color: var(--text-bright); text-transform: uppercase; letter-spacing: 0.06em; font-family: 'Roboto Mono', monospace; }
.card-header .sep { flex: 1; }
.card-body { padding: 20px; }
.charts-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 16px; }
.chart-container { position: relative; height: 220px; }

/* ===== TABLE ===== */
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th { padding: 10px 14px; text-align: left; font-size: 10px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); font-family: 'Roboto Mono', monospace; border-bottom: 1px solid var(--border); white-space: nowrap; }
tbody tr { border-bottom: 1px solid rgba(204,0,0,0.07); transition: background 0.15s; cursor: pointer; }
tbody tr:hover { background: rgba(204,0,0,0.04); }
tbody td { padding: 11px 14px; color: var(--text-main); vertical-align: middle; }
.td-desc { max-width: 320px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-bright); }
.td-id   { font-family: 'Roboto Mono', monospace; color: var(--text-dim); font-size: 11px; }
.td-date { font-family: 'Roboto Mono', monospace; font-size: 11px; white-space: nowrap; }

/* ===== BADGES ===== */
.badge { display: inline-block; padding: 3px 10px; border-radius: 99px; font-size: 10.5px; font-weight: 600; letter-spacing: 0.04em; white-space: nowrap; }
/* Original states */
.badge-new        { background: rgba(74,158,206,0.15); color: #4a9ece; border: 1px solid rgba(74,158,206,0.3); }
.badge-bug        { background: rgba(217,79,79,0.15);  color: #d94f4f; border: 1px solid rgba(217,79,79,0.3); }
.badge-open       { background: rgba(224,123,32,0.15); color: var(--warn); border: 1px solid rgba(224,123,32,0.3); }
.badge-inprogress { background: rgba(232,160,32,0.15); color: #c88a00; border: 1px solid rgba(232,160,32,0.3); }
.badge-resolved   { background: rgba(46,158,107,0.15); color: var(--success); border: 1px solid rgba(46,158,107,0.3); }
/* PDF User Story states */
.badge-draft      { background: rgba(150,150,150,0.15); color: #888; border: 1px solid rgba(150,150,150,0.3); }
.badge-forreview  { background: rgba(74,158,206,0.15);  color: #4a9ece; border: 1px solid rgba(74,158,206,0.3); }
.badge-approved   { background: rgba(46,158,107,0.15);  color: var(--success); border: 1px solid rgba(46,158,107,0.3); }
.badge-indev      { background: rgba(74,100,206,0.15);  color: #4a64ce; border: 1px solid rgba(74,100,206,0.3); }
.badge-fortesting { background: rgba(224,123,32,0.15);  color: var(--warn); border: 1px solid rgba(224,123,32,0.3); }
.badge-qafailed   { background: rgba(217,79,79,0.15);   color: #d94f4f; border: 1px solid rgba(217,79,79,0.3); }
.badge-foruat     { background: rgba(160,80,206,0.15);  color: #a050ce; border: 1px solid rgba(160,80,206,0.3); }
.badge-readydeploy{ background: rgba(32,180,140,0.15);  color: #20b48c; border: 1px solid rgba(32,180,140,0.3); }
.badge-deployed   { background: rgba(46,158,107,0.25);  color: var(--success); border: 1px solid rgba(46,158,107,0.5); }
.badge-closed     { background: rgba(50,50,50,0.1);     color: #555; border: 1px solid rgba(50,50,50,0.2); }

.pri-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; font-family: 'Roboto Mono', monospace; }
.pri-1urgent   { background: rgba(150,0,0,0.2);    color: #cc0000; }
.pri-2critical { background: rgba(217,79,79,0.2);  color: #d94f4f; }
.pri-3high     { background: rgba(224,123,32,0.2); color: var(--warn); }
.pri-4medium   { background: rgba(232,160,32,0.2); color: #c88a00; }
.pri-5low      { background: rgba(46,158,107,0.2); color: var(--success); }
/* Legacy priority badges */
.pri-critical  { background: rgba(217,79,79,0.2);  color: #d94f4f; }
.pri-high      { background: rgba(224,123,32,0.2); color: var(--warn); }
.pri-medium    { background: rgba(232,160,32,0.2); color: #c88a00; }
.pri-low       { background: rgba(46,158,107,0.2); color: var(--success); }

/* Story points badge */
.sp-badge { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; font-size: 11px; font-weight: 700; font-family: 'Roboto Mono', monospace; background: rgba(204,0,0,0.1); color: var(--accent); border: 1px solid rgba(204,0,0,0.2); }

/* ===== BUTTONS ===== */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 7px; font-family: 'Raleway', sans-serif; font-size: 12.5px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
.btn-primary { background: #ffffff; color: #000000; border: 1px solid #cccccc; }
.btn-primary:hover { background: #f0f0f0; }
.btn-ghost   { background: #ffffff; color: #000000; border: 1px solid #cccccc; }
.btn-ghost:hover { background: #f0f0f0; border-color: #999; }
.btn-danger  { background: #ffffff; color: #cc0000; border: 1px solid #ffcccc; }
.btn-danger:hover { background: #fff0f0; }
.btn-success { background: rgba(46,158,107,0.15); color: var(--success); border: 1px solid rgba(46,158,107,0.3); }
.btn-success:hover { background: rgba(46,158,107,0.25); }
.btn-sm  { padding: 5px 10px; font-size: 11.5px; }
.btn-xs  { padding: 3px 8px; font-size: 10.5px; }

/* ===== FILTER BAR ===== */
.filter-bar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.filter-select { background: #ffffff; border: 1px solid var(--border); border-radius: 7px; color: var(--text-main); padding: 6px 12px; font-family: 'Raleway', sans-serif; font-size: 12.5px; cursor: pointer; outline: none; transition: border-color 0.2s; }
.filter-select:hover, .filter-select:focus { border-color: rgba(204,0,0,0.4); }
.filter-select option { background: #ffffff; color: #333333; }

/* ===== MODAL ===== */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #ffffff; border: 1px solid var(--border); border-radius: var(--radius-lg); width: 540px; max-width: 95vw; max-height: 90vh; overflow-y: auto; animation: slideUp 0.25s ease; }
@keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
.modal-header { padding: 20px 24px 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
.modal-title  { font-size: 14px; font-weight: 700; color: #cc0000; text-transform: uppercase; letter-spacing: 0.06em; font-family: 'Roboto Mono', monospace; }
.modal-close  { margin-left: auto; background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer; line-height: 1; transition: color 0.2s; }
.modal-close:hover { color: #333; }
.modal-body   { padding: 24px; display: flex; flex-direction: column; gap: 16px; color: #333; }
.modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end; }

/* ===== FORM ===== */
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-row   { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
label { font-size: 10.5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); font-family: 'Roboto Mono', monospace; }
input[type="text"], input[type="email"], input[type="date"],
textarea, select.form-control {
  background: #ffffff; border: 1px solid var(--border); border-radius: 7px;
  color: var(--text-bright); font-family: 'Raleway', sans-serif; font-size: 13px;
  padding: 9px 12px; width: 100%; outline: none; transition: border-color 0.2s;
}
input:focus, textarea:focus, select.form-control:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 80px; }
select.form-control option { background: #ffffff; color: #333333; }

/* ===== STORY POINTS TABLE ===== */
.sp-table { width: 100%; border-collapse: collapse; font-size: 11.5px; margin-top: 6px; }
.sp-table th { padding: 6px 10px; background: #f8f8f8; border: 1px solid #eee; text-align: left; font-family: 'Roboto Mono', monospace; font-size: 10px; color: #888; }
.sp-table td { padding: 6px 10px; border: 1px solid #eee; }

/* ===== DETAIL PANEL ===== */
.detail-panel { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; }
.detail-meta  { display: flex; flex-direction: column; gap: 10px; }
.meta-row { display: flex; align-items: flex-start; gap: 10px; }
.meta-key { font-size: 10.5px; font-weight: 600; letter-spacing: 0.08em; color: var(--text-dim); text-transform: uppercase; font-family: 'Roboto Mono', monospace; min-width: 110px; padding-top: 2px; }
.meta-val { color: var(--text-bright); font-size: 13px; }

/* ===== COMMENTS ===== */
.comments-section { display: flex; flex-direction: column; gap: 10px; }
.comment-item { background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 10px 14px; }
.comment-author { font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 3px; }
.comment-time   { font-size: 10px; color: var(--text-dim); font-family: 'Roboto Mono', monospace; float: right; }
.comment-text   { font-size: 12.5px; color: var(--text-main); }
.comment-input-row { display: flex; gap: 8px; margin-top: 6px; }
.comment-input-row textarea { flex: 1; min-height: 50px; resize: none; }

/* ===== IMPORT ===== */
.drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: 40px 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
.drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent); background: rgba(204,0,0,0.03); }
.drop-zone .dz-icon  { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
.drop-zone .dz-title { font-size: 15px; font-weight: 600; color: var(--text-bright); margin-bottom: 4px; }
.drop-zone .dz-sub   { font-size: 12px; color: var(--text-dim); }

/* ===== REPORTS ===== */
.report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.report-stat-box { background: #f8f8f8; border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
.report-stat-box .rs-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; font-family: 'Roboto Mono', monospace; }
.report-stat-box .rs-val   { font-size: 26px; font-weight: 700; color: var(--text-bright); }
.report-history-item { display: flex; align-items: center; gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border); }
.report-history-item:last-child { border-bottom: none; }
.rh-icon  { font-size: 22px; }
.rh-info  { flex: 1; }
.rh-title { font-size: 13px; font-weight: 600; color: var(--text-bright); }
.rh-sub   { font-size: 11px; color: var(--text-dim); font-family: 'Roboto Mono', monospace; }

/* ===== ATTACHMENTS ===== */
.attachments-section { margin-top: 16px; border-top: 1px solid #eee; padding-top: 14px; }
.attachments-header  { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #888; font-family: 'Roboto Mono', monospace; margin-bottom: 10px; }
.attachment-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.attachment-item { display: flex; align-items: center; gap: 10px; background: #f8f8f8; border: 1px solid #eee; border-radius: 8px; padding: 8px 12px; font-size: 12px; }
.attachment-icon { font-size: 18px; flex-shrink: 0; }
.attachment-name { flex: 1; font-weight: 600; color: #333; word-break: break-all; }
.attachment-size { color: #aaa; font-family: 'Roboto Mono', monospace; font-size: 10px; flex-shrink: 0; }
.attachment-download { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 3px 10px; font-size: 11px; cursor: pointer; color: #333; text-decoration: none; flex-shrink: 0; }
.attachment-download:hover { background: #f0f0f0; }
.attachment-delete { background: #fff; border: 1px solid #ffcccc; border-radius: 6px; padding: 3px 8px; font-size: 11px; cursor: pointer; color: #cc0000; flex-shrink: 0; }
.attachment-delete:hover { background: #fff0f0; }
.attachment-upload-area { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.attachment-count { font-size: 11px; color: #888; font-family: 'Roboto Mono', monospace; }
.btn-upload { background: #fff; border: 1px dashed #cc0000; border-radius: 8px; padding: 7px 16px; font-size: 12px; cursor: pointer; color: #cc0000; font-family: 'Raleway', sans-serif; font-weight: 600; transition: all 0.2s; }
.btn-upload:hover { background: #fff0f0; }
.btn-upload:disabled { opacity: 0.5; cursor: not-allowed; }

/* ===== ACCEPTANCE CRITERIA ===== */
.ac-box { background: #f8fff8; border: 1px solid rgba(46,158,107,0.2); border-radius: 8px; padding: 12px 14px; font-size: 12.5px; color: #333; white-space: pre-wrap; line-height: 1.6; }
.ac-empty { color: #aaa; font-style: italic; font-size: 12px; }

/* ===== TOAST ===== */
#toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; font-size: 13px; color: var(--text-bright); display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); animation: toastIn 0.3s ease; min-width: 260px; max-width: 380px; }
.toast.success { border-left: 3px solid var(--success); }
.toast.error   { border-left: 3px solid var(--danger); }
.toast.info    { border-left: 3px solid var(--sky); }
@keyframes toastIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }

/* ===== LOADER / EMPTY ===== */
.loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
.empty-state .es-icon  { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
.empty-state .es-title { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
.empty-state .es-sub   { font-size: 12.5px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) { .charts-row, .detail-panel, .report-grid { grid-template-columns: 1fr; } }
@media (max-width: 700px) { #sidebar { transform: translateX(-100%); } #sidebar.open { transform: translateX(0); } #main { margin-left: 0; } .form-row, .form-row-3 { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <img src="logo/castlestechlogo.png" alt="Castles Technology" style="width:36px;height:36px;object-fit:contain;flex-shrink:0;" onerror="this.style.display='none'">
      <div>
        <div class="logo-text">IssueTracker</div>
        <div class="logo-sub">Castles Technology Enterprise v2.0</div>
      </div>
    </div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-section-label">Main</div>
    <a class="nav-item active" data-view="dashboard"><span class="icon">üìä</span> Dashboard</a>
    <a class="nav-item" data-view="issues"><span class="icon">üîé</span> All Issues <span class="nav-badge" id="badge-open">‚Äì</span></a>
    <div class="nav-section-label">Management</div>
    <a class="nav-item" data-view="new-issue"><span class="icon">‚ûï</span> New Issue</a>
    <a class="nav-item" data-view="import"><span class="icon">üì•</span> Import CSV</a>
    <div class="nav-section-label">Analytics</div>
    <a class="nav-item" data-view="reports"><span class="icon">üìã</span> Reports</a>
  </div>
  <div class="sidebar-footer">API: <span style="color:rgba(255,255,255,0.5)">localhost/issuetracker</span></div>
</nav>

<!-- ===== MAIN ===== -->
<div id="main">
  <div id="topbar">
    <div class="topbar-title" id="topbar-title">Dashboard</div>
    <div class="topbar-sep"></div>
    <div class="topbar-search">
      <span>üîç</span>
      <input type="text" id="global-search" placeholder="Search issues‚Ä¶" />
    </div>
    <button class="topbar-btn" onclick="navigate('new-issue')">‚ûï New Issue</button>
  </div>

  <div id="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="view active" id="view-dashboard">
      <div class="stat-row" id="stat-row">
        <div class="stat-card c-total"><div class="stat-label">Total</div><div class="stat-value" id="s-total">‚Äì</div><div class="stat-icon">üì¶</div></div>
        <div class="stat-card c-new"><div class="stat-label">New/Draft</div><div class="stat-value" id="s-new">‚Äì</div><div class="stat-icon">üÜï</div></div>
        <div class="stat-card c-bug"><div class="stat-label">Bugs/Failed</div><div class="stat-value" id="s-bug">‚Äì</div><div class="stat-icon">üêõ</div></div>
        <div class="stat-card c-open"><div class="stat-label">Open</div><div class="stat-value" id="s-open">‚Äì</div><div class="stat-icon">üìÇ</div></div>
        <div class="stat-card c-prog"><div class="stat-label">In Progress</div><div class="stat-value" id="s-prog">‚Äì</div><div class="stat-icon">‚öô</div></div>
        <div class="stat-card c-res"><div class="stat-label">Resolved</div><div class="stat-value" id="s-res">‚Äì</div><div class="stat-icon">‚úÖ</div></div>
      </div>
      <div class="charts-row">
        <div class="card">
          <div class="card-header"><div class="card-title">Issues by Priority</div></div>
          <div class="card-body"><div class="chart-container"><canvas id="chart-priority"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Issues by Dashboard</div></div>
          <div class="card-body"><div class="chart-container"><canvas id="chart-dashboard"></canvas></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Issues</div>
          <div class="sep"></div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('issues')">View All ‚Üí</button>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrapper">
            <table>
              <thead><tr><th>#</th><th>Dashboard</th><th>Description</th><th>State</th><th>Priority</th><th>SP</th><th>Issued By</th><th>Date</th></tr></thead>
              <tbody id="recent-issues-body"><tr><td colspan="8"><div class="empty-state"><div class="loader"></div></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ALL ISSUES ===== -->
    <div class="view" id="view-issues">
      <div class="card">
        <div class="card-header">
          <div class="card-title">All Issues</div>
          <div class="sep"></div>
          <div class="filter-bar">
            <select class="filter-select" id="filter-state" onchange="loadIssues()">
              <option value="">All States</option>
              <optgroup label="User Story States">
                <option>Draft</option><option>For Review</option><option>Approved</option>
                <option>In Development</option><option>For Testing</option><option>QA Failed</option>
                <option>For UAT</option><option>Ready for Deployment</option><option>Deployed</option><option>Closed</option>
              </optgroup>
              <optgroup label="Legacy">
                <option>New</option><option>Bug</option><option>Open</option><option>In Progress</option><option>Resolved</option>
              </optgroup>
            </select>
            <select class="filter-select" id="filter-priority" onchange="loadIssues()">
              <option value="">All Priorities</option>
              <option>1-Urgent</option><option>2-Critical</option><option>3-High</option>
              <option>4-Medium</option><option>5-Low</option>
              <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
            </select>
            <button class="btn btn-ghost btn-sm" onclick="exportIssues()">‚¨á Export CSV</button>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrapper">
            <table>
              <thead><tr><th>#</th><th>Dashboard</th><th>Module</th><th>Description</th><th>State</th><th>Priority</th><th>SP</th><th>Sprint</th><th>Assigned To</th><th>Date</th><th></th></tr></thead>
              <tbody id="issues-body"><tr><td colspan="11"><div class="empty-state"><div class="loader"></div></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== NEW ISSUE ===== -->
    <div class="view" id="view-new-issue">
      <div class="card">
        <div class="card-header"><div class="card-title">Log New Issue / User Story</div></div>
        <div class="card-body">
          <form id="new-issue-form" onsubmit="submitNewIssue(event)" style="display:flex;flex-direction:column;gap:16px;">

            <!-- Header Section -->
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'Roboto Mono',monospace;padding-bottom:4px;border-bottom:1px solid #eee;">Header Section</div>

            <div class="form-group">
              <label>Title <span style="color:#aaa;font-size:9px;">(Short description)</span></label>
              <input type="text" id="ni-title" placeholder="e.g. Add inventory export feature" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Dashboard</label>
                <input type="text" id="ni-dashboard" placeholder="e.g. MSP Dashboard" />
              </div>
              <div class="form-group">
                <label>Module</label>
                <input type="text" id="ni-module" placeholder="e.g. Inventory" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>State</label>
                <select class="form-control" id="ni-state">
                  <option value="" disabled selected>-- Select State --</option>
                  <optgroup label="User Story States">
                    <option selected>Draft</option><option>For Review</option><option>Approved</option>
                    <option>In Development</option><option>For Testing</option><option>QA Failed</option>
                    <option>For UAT</option><option>Ready for Deployment</option><option>Deployed</option><option>Closed</option>
                  </optgroup>
                  <optgroup label="Legacy">
                    <option>New</option><option>Bug</option><option>Open</option><option>In Progress</option><option>Resolved</option>
                  </optgroup>
                </select>
              </div>
              <div class="form-group">
                <label>Assigned To</label>
                <select class="form-control" id="ni-assigned-to">
                  <option value="">‚Äî Unassigned ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Area Path <span style="color:#aaa;font-size:9px;">(Team/Dept, optional)</span></label>
                <input type="text" id="ni-area-path" placeholder="e.g. Backend Team" />
              </div>
              <div class="form-group">
                <label>Iteration Path <span style="color:#aaa;font-size:9px;">(Sprint)</span></label>
                <input type="text" id="ni-iteration-path" placeholder="e.g. Sprint 5" />
              </div>
            </div>

            <!-- Main Section -->
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'Roboto Mono',monospace;padding-bottom:4px;border-bottom:1px solid #eee;margin-top:8px;">Main Section</div>

            <div class="form-group">
              <label>Description *</label>
              <textarea id="ni-desc" placeholder="Describe the issue or user story in detail‚Ä¶" rows="4" required></textarea>
            </div>

            <!-- Right Panel Fields -->
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'Roboto Mono',monospace;padding-bottom:4px;border-bottom:1px solid #eee;margin-top:8px;">Planning Fields</div>

            <div class="form-row-3">
              <div class="form-group">
                <label>Story Points</label>
                <select class="form-control" id="ni-story-points">
                  <option value="">‚Äî None ‚Äî</option>
                  <option value="1">1 (1‚Äì2 hrs)</option>
                  <option value="2">2 (3‚Äì4 hrs)</option>
                  <option value="3">3 (5‚Äì8 hrs)</option>
                  <option value="5">5 (8‚Äì16 hrs)</option>
                  <option value="8">8 (24‚Äì32 hrs)</option>
                  <option value="13">13 (40‚Äì56 hrs)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Priority</label>
                <select class="form-control" id="ni-priority">
                  <option value="1-Urgent">1 ‚Äì Urgent</option>
                  <option value="2-Critical">2 ‚Äì Critical</option>
                  <option value="3-High">3 ‚Äì High</option>
                  <option value="4-Medium" selected>4 ‚Äì Medium</option>
                  <option value="5-Low">5 ‚Äì Low</option>
                </select>
              </div>
              <div class="form-group">
                <label>Issued By</label>
                <select class="form-control" id="ni-issued-by">
                  <option value="">‚Äî Select ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Date Identified</label>
              <input type="date" id="ni-date" required />
            </div>

            <!-- Development Section -->
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'Roboto Mono',monospace;padding-bottom:4px;border-bottom:1px solid #eee;margin-top:8px;">Development Section</div>

            <div class="form-group">
              <label>Acceptance Criteria</label>
              <textarea id="ni-acceptance-criteria" placeholder="Conditions that must be met for this story to be considered complete‚Ä¶" rows="4"></textarea>
            </div>

            <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:6px;">
              <button type="button" class="btn btn-ghost" onclick="navigate('issues')">Cancel</button>
              <button type="submit" class="btn btn-primary" id="ni-submit-btn">Create Issue</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== IMPORT ===== -->
    <div class="view" id="view-import">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Import CSV File</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="drop-zone" id="drop-zone" onclick="document.getElementById('csv-file').click()">
              <div class="dz-icon">üìÇ</div>
              <div class="dz-title">Drop CSV file here</div>
              <div class="dz-sub">or click to browse ‚Äî Max 10MB</div>
              <input type="file" id="csv-file" accept=".csv" style="display:none" onchange="handleFileSelect(event)" />
            </div>
            <div id="file-preview" style="display:none;">
              <div style="background:rgba(46,158,107,0.1);border:1px solid rgba(46,158,107,0.3);border-radius:8px;padding:12px 16px;display:flex;align-items:center;gap:10px;">
                <span style="font-size:22px;">üìÑ</span>
                <div>
                  <div style="font-weight:600;color:var(--text-bright)" id="file-name-display"></div>
                  <div style="font-size:11px;color:var(--text-dim)" id="file-size-display"></div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="clearFile()" style="margin-left:auto;">‚úï</button>
              </div>
            </div>
            <div class="form-group">
              <label>Imported By</label>
              <select class="form-control" id="import-user">
                <option value="">‚Äî Select User ‚Äî</option>
              </select>
            </div>
            <button class="btn btn-primary" id="import-btn" onclick="doImport()">üì• Import File</button>
            <div id="import-result" style="display:none;"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">CSV Format Guide</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
            <p style="font-size:12.5px;color:var(--text-dim);">Your CSV must include these columns in order:</p>
            <div style="background:#f5f5f5;border-radius:8px;padding:14px;font-family:'Roboto Mono',monospace;font-size:11px;color:#333;line-height:2;overflow-x:auto;">
              ID, Description, State, Date Identified, Issued by, Priority
            </div>
            <p style="font-size:12.5px;color:var(--text-dim);">Description supports pipe-separated format:</p>
            <div style="background:#f5f5f5;border-radius:8px;padding:14px;font-family:'Roboto Mono',monospace;font-size:11px;color:#cc0000;line-height:2;overflow-x:auto;">
              MSP Dashboard | Inventory | Issue description here
            </div>
            <p style="font-size:11.5px;color:var(--text-dim);">Valid states: <span style="color:#cc0000">Draft, For Review, Approved, In Development, For Testing, QA Failed, For UAT, Ready for Deployment, Deployed, Closed, New, Bug, Open, In Progress, Resolved</span></p>
            <p style="font-size:11.5px;color:var(--text-dim);">Valid priorities: <span style="color:#cc0000">1-Urgent, 2-Critical, 3-High, 4-Medium, 5-Low</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== REPORTS ===== -->
    <div class="view" id="view-reports">
      <div class="card">
        <div class="card-header"><div class="card-title">Generate Report</div></div>
        <div class="card-body" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
          <div class="form-group" style="min-width:160px;">
            <label>Date Range</label>
            <select class="form-control" id="rpt-date-range">
              <option>Last 7 Days</option><option selected>Last 30 Days</option>
              <option>Last 90 Days</option><option>This Year</option>
            </select>
          </div>
          <div class="form-group" style="min-width:160px;">
            <label>Status Filter</label>
            <select class="form-control" id="rpt-status-filter">
              <option>All Statuses</option>
              <option>Draft</option><option>For Review</option><option>Approved</option>
              <option>In Development</option><option>For Testing</option><option>QA Failed</option>
              <option>For UAT</option><option>Ready for Deployment</option><option>Deployed</option><option>Closed</option>
            </select>
          </div>
          <div style="align-self:flex-end;padding-bottom:2px;">
            <button class="btn btn-primary" onclick="generateReport()">‚ö° Generate Report</button>
          </div>
        </div>
      </div>
      <div id="latest-report-section" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Latest Report</div>
            <div class="sep"></div>
            <button class="btn btn-success btn-sm" id="export-report-btn">‚¨á Download CSV</button>
          </div>
          <div class="card-body">
            <div class="report-grid" id="report-grid"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Report History</div></div>
        <div class="card-body" id="report-history"><div class="empty-state"><div class="loader"></div></div></div>
      </div>
    </div>

  </div>
</div>

<!-- ===== ISSUE DETAIL MODAL ===== -->
<div class="modal-overlay" id="issue-detail-modal">
  <div class="modal" style="width:750px;">
    <div class="modal-header">
      <div class="modal-title">Issue / User Story Detail</div>
      <button class="modal-close" onclick="closeModal('issue-detail-modal')">‚úï</button>
    </div>
    <div class="modal-body" id="issue-detail-body">
      <div class="empty-state"><div class="loader"></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" id="delete-issue-btn">üóë Delete</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('issue-detail-modal')">Close</button>
      <button class="btn btn-primary btn-sm" id="edit-issue-btn">‚úè Edit</button>
    </div>
  </div>
</div>

<!-- ===== EDIT MODAL ===== -->
<div class="modal-overlay" id="edit-issue-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Update Issue</div>
      <button class="modal-close" onclick="closeModal('edit-issue-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>State</label>
          <select class="form-control" id="edit-state">
            <optgroup label="User Story States">
              <option>Draft</option><option>For Review</option><option>Approved</option>
              <option>In Development</option><option>For Testing</option><option>QA Failed</option>
              <option>For UAT</option><option>Ready for Deployment</option><option>Deployed</option><option>Closed</option>
            </optgroup>
            <optgroup label="Legacy">
              <option>New</option><option>Bug</option><option>Open</option><option>In Progress</option><option>Resolved</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select class="form-control" id="edit-priority">
            <option>1-Urgent</option><option>2-Critical</option><option>3-High</option><option>4-Medium</option><option>5-Low</option>
            <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Story Points</label>
          <select class="form-control" id="edit-story-points">
            <option value="">‚Äî None ‚Äî</option>
            <option value="1">1 (1‚Äì2 hrs)</option><option value="2">2 (3‚Äì4 hrs)</option>
            <option value="3">3 (5‚Äì8 hrs)</option><option value="5">5 (8‚Äì16 hrs)</option>
            <option value="8">8 (24‚Äì32 hrs)</option><option value="13">13 (40‚Äì56 hrs)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Assigned To</label>
          <select class="form-control" id="edit-assigned-to">
            <option value="">‚Äî Unassigned ‚Äî</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Iteration Path (Sprint)</label>
          <input type="text" id="edit-iteration-path" placeholder="e.g. Sprint 5" />
        </div>
        <div class="form-group">
          <label>Area Path (Team)</label>
          <input type="text" id="edit-area-path" placeholder="e.g. Backend Team" />
        </div>
      </div>
      <div class="form-group">
        <label>Acceptance Criteria</label>
        <textarea id="edit-acceptance-criteria" rows="4" placeholder="Conditions for story completion‚Ä¶"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-issue-modal')">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const API = 'http://localhost/issuetracker/api';

// ============================================================
// STATE
// ============================================================
let currentIssueId  = null;
let currentReportId = null;
let allUsers        = [];
let charts          = {};
let searchTimeout   = null;

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  loadUsers();
  loadDashboard();
  setTodayDate();

  document.querySelectorAll('.nav-item[data-view]').forEach(item => {
    item.addEventListener('click', () => navigate(item.dataset.view));
  });

  document.getElementById('global-search').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (document.getElementById('view-issues').classList.contains('active')) loadIssues();
    }, 350);
  });

  // Drag & drop
  const dz = document.getElementById('drop-zone');
  dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) setFile(file);
  });
});

// ============================================================
// NAVIGATION
// ============================================================
function navigate(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`view-${view}`)?.classList.add('active');
  document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');
  const titles = { dashboard:'Dashboard', issues:'All Issues', 'new-issue':'Log New Issue', import:'Import CSV', reports:'Reports' };
  document.getElementById('topbar-title').textContent = titles[view] || view;
  if (view === 'issues')   loadIssues();
  if (view === 'reports')  loadReportHistory();
  if (view === 'new-issue') setTodayDate();
}

// ============================================================
// API HELPER
// ============================================================
async function apiFetch(url, opts = {}) {
  try {
    const res = await fetch(`${API}${url}`, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    return await res.json();
  } catch (e) {
    toast('Connection error. Check if XAMPP Apache is running.', 'error');
    throw e;
  }
}

// ============================================================
// USERS
// ============================================================
async function loadUsers() {
  try {
    const res = await apiFetch('/get_users.php');
    allUsers = res.data || [];
    populateUserSelects();
  } catch { allUsers = []; }
}

function populateUserSelects() {
  const selects = ['ni-issued-by', 'ni-assigned-to', 'import-user', 'edit-assigned-to'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const first = sel.options[0];
    sel.innerHTML = '';
    sel.appendChild(first);
    allUsers.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.name;
      sel.appendChild(opt);
    });
  });
}

// ============================================================
// DASHBOARD
// ============================================================
async function loadDashboard() {
  try {
    const res = await apiFetch('/get_stats.php');
    const d = res.data;
    if (!d) return;
    document.getElementById('s-total').textContent = d.totalIssues;
    document.getElementById('s-new').textContent   = d.newCount;
    document.getElementById('s-bug').textContent   = d.bugCount;
    document.getElementById('s-open').textContent  = d.openCount;
    document.getElementById('s-prog').textContent  = d.inProgressCount;
    document.getElementById('s-res').textContent   = d.resolvedCount;
    document.getElementById('badge-open').textContent = d.openCount + d.bugCount + d.newCount;
    renderPriorityChart(d.byPriority);
    renderDashboardChart(d.byDashboard);
    loadRecentIssues();
  } catch { }
}

function renderPriorityChart(data) {
  if (charts['priority']) charts['priority'].destroy();
  const ctx = document.getElementById('chart-priority').getContext('2d');
  charts['priority'] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.map(d => d.priority),
      datasets: [{
        data: data.map(d => d.count),
        backgroundColor: ['#cc0000','#d94f4f','#e07b20','#c88a00','#2e9e6b'],
        borderColor: 'rgba(255,255,255,0.8)',
        borderWidth: 2,
        hoverOffset: 6
      }]
    },
    options: {
      plugins: { legend: { position:'bottom', labels:{ color:'#666', font:{ size:11, family:'Raleway' }, padding:14 } } },
      cutout: '60%',
      maintainAspectRatio: false
    }
  });
}

function renderDashboardChart(data) {
  if (charts['dashboard']) charts['dashboard'].destroy();
  const ctx = document.getElementById('chart-dashboard').getContext('2d');
  charts['dashboard'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => d.dashboard.replace(' Dashboard','')),
      datasets: [{ label:'Issues', data: data.map(d => d.count), backgroundColor:'rgba(204,0,0,0.5)', borderColor:'rgba(204,0,0,0.9)', borderWidth:1, borderRadius:4 }]
    },
    options: {
      plugins: { legend:{ display:false } },
      scales: {
        x: { ticks:{ color:'#888', font:{ size:10 } }, grid:{ color:'rgba(0,0,0,0.05)' } },
        y: { ticks:{ color:'#888', font:{ size:10 } }, grid:{ color:'rgba(0,0,0,0.05)' }, beginAtZero:true }
      },
      maintainAspectRatio: false
    }
  });
}

// ============================================================
// RECENT ISSUES
// ============================================================
async function loadRecentIssues() {
  try {
    const res = await apiFetch('/get_issues.php');
    const issues = (res.data || []).slice(0, 8);
    const tbody = document.getElementById('recent-issues-body');
    tbody.innerHTML = issues.length ? issues.map(i => recentIssueRow(i)).join('') : emptyRow(8,'No issues found.');
  } catch { }
}

function recentIssueRow(i) {
  return `<tr onclick="viewIssue(${i.id})">
    <td class="td-id">#${i.id}</td>
    <td style="font-size:12px;">${escHtml(i.dashboard||'‚Äî')}</td>
    <td class="td-desc">${escHtml(i.description)}</td>
    <td>${stateBadge(i.state)}</td>
    <td>${priBadge(i.priority)}</td>
    <td>${i.story_points ? `<span class="sp-badge">${i.story_points}</span>` : '‚Äî'}</td>
    <td style="font-size:12px;">${escHtml(i.issued_by_name||'‚Äî')}</td>
    <td class="td-date">${fmtDate(i.date_identified)}</td>
  </tr>`;
}

// ============================================================
// ALL ISSUES
// ============================================================
async function loadIssues() {
  const state    = document.getElementById('filter-state')?.value    || '';
  const priority = document.getElementById('filter-priority')?.value || '';
  const search   = document.getElementById('global-search')?.value   || '';
  const params   = new URLSearchParams();
  if (state)    params.set('state', state);
  if (priority) params.set('priority', priority);
  if (search)   params.set('search', search);

  try {
    const res = await apiFetch(`/get_issues.php?${params}`);
    const issues = res.data || [];
    const tbody = document.getElementById('issues-body');
    tbody.innerHTML = issues.length ? issues.map(i => allIssueRow(i)).join('') : emptyRow(11,'No issues found. Try adjusting filters.');
  } catch { }
}

function allIssueRow(i) {
  return `<tr onclick="viewIssue(${i.id})">
    <td class="td-id">#${i.id}</td>
    <td style="font-size:12px;white-space:nowrap;">${escHtml(i.dashboard||'‚Äî')}</td>
    <td style="font-size:12px;">${escHtml(i.module||'‚Äî')}</td>
    <td class="td-desc">${escHtml(i.title || i.description)}</td>
    <td>${stateBadge(i.state)}</td>
    <td>${priBadge(i.priority)}</td>
    <td>${i.story_points ? `<span class="sp-badge">${i.story_points}</span>` : '‚Äî'}</td>
    <td style="font-size:11px;color:#888;">${escHtml(i.iteration_path||'‚Äî')}</td>
    <td style="font-size:12px;">${escHtml(i.assigned_to_name||'‚Äî')}</td>
    <td class="td-date">${fmtDate(i.date_identified)}</td>
    <td><button class="btn btn-ghost btn-xs">View</button></td>
  </tr>`;
}

// ============================================================
// ISSUE DETAIL
// ============================================================
async function viewIssue(id) {
  currentIssueId = id;
  openModal('issue-detail-modal');
  document.getElementById('issue-detail-body').innerHTML = '<div style="text-align:center;padding:40px;"><div class="loader"></div></div>';

  try {
    const [iRes, cRes, aRes] = await Promise.all([
      apiFetch(`/get_issue_detail.php?id=${id}`),
      apiFetch(`/comments.php?issueId=${id}`),
      apiFetch(`/attachments.php?issueId=${id}`)
    ]);

    const issue       = iRes.data;
    const comments    = cRes.data || [];
    const attachments = aRes.data || [];

    document.getElementById('issue-detail-body').innerHTML = `
      <div class="detail-panel">
        <div>
          <h2 style="font-size:15px;font-weight:700;color:var(--text-bright);margin-bottom:4px;line-height:1.4;">${escHtml(issue.title || '‚Äî')}</h2>
          <p style="font-size:12.5px;color:#666;margin-bottom:14px;line-height:1.5;">${escHtml(issue.description)}</p>
          <div class="detail-meta">
            <div class="meta-row"><span class="meta-key">State</span><span class="meta-val">${stateBadge(issue.state)}</span></div>
            <div class="meta-row"><span class="meta-key">Priority</span><span class="meta-val">${priBadge(issue.priority)}</span></div>
            <div class="meta-row"><span class="meta-key">Story Points</span><span class="meta-val">${issue.storyPoints ? `<span class="sp-badge">${issue.storyPoints}</span> <span style="font-size:11px;color:#888;">${spHours(issue.storyPoints)}</span>` : '‚Äî'}</span></div>
            <div class="meta-row"><span class="meta-key">Dashboard</span><span class="meta-val">${escHtml(issue.dashboard||'‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Module</span><span class="meta-val">${escHtml(issue.module||'‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Area Path</span><span class="meta-val">${escHtml(issue.areaPath||'‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Sprint</span><span class="meta-val">${escHtml(issue.iterationPath||'‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Issued By</span><span class="meta-val">${escHtml(issue.issuedByName||'‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Assigned To</span><span class="meta-val">${escHtml(issue.assignedToName||'Unassigned')}</span></div>
            <div class="meta-row"><span class="meta-key">Date</span><span class="meta-val" style="font-family:'Roboto Mono',monospace;font-size:12px;">${fmtDate(issue.dateIdentified||issue.date_identified)}</span></div>
            <div class="meta-row"><span class="meta-key">Source</span><span class="meta-val" style="font-size:12px;">${escHtml(issue.source||'Manual')}</span></div>
          </div>
          ${issue.acceptanceCriteria ? `
          <div style="margin-top:14px;">
            <div style="font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);font-family:'Roboto Mono',monospace;margin-bottom:6px;">‚úÖ Acceptance Criteria</div>
            <div class="ac-box">${escHtml(issue.acceptanceCriteria)}</div>
          </div>` : `
          <div style="margin-top:14px;">
            <div style="font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);font-family:'Roboto Mono',monospace;margin-bottom:6px;">‚úÖ Acceptance Criteria</div>
            <div class="ac-empty">No acceptance criteria defined.</div>
          </div>`}
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'Roboto Mono',monospace;margin-bottom:10px;">
            üí¨ Discussion (${comments.length})
          </div>
          <div class="comments-section" id="comments-list">
            ${comments.length
              ? comments.map(c => `
                <div class="comment-item">
                  <div><span class="comment-author">${escHtml(c.author || c.user_name || 'User')}</span>
                  <span class="comment-time">${fmtDate(c.created_at)}</span></div>
                  <div class="comment-text">${escHtml(c.comment)}</div>
                </div>`).join('')
              : `<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">No comments yet.</div>`
            }
          </div>
          <div class="comment-input-row" style="margin-top:12px;">
            <select class="form-control" id="comment-user-select" style="max-width:130px;">
              ${allUsers.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
            </select>
            <textarea id="comment-text" placeholder="Add a comment‚Ä¶"></textarea>
            <button class="btn btn-primary btn-sm" onclick="addComment()" style="align-self:flex-end;">Post</button>
          </div>
        </div>
      </div>
      <div class="attachments-section">
        <div class="attachments-header">üìé Attachments (${attachments.length}/5)</div>
        <div class="attachment-list" id="attachment-list">
          ${attachments.length
            ? attachments.map(a => attachmentHTML(a, id)).join('')
            : `<div style="color:#aaa;font-size:12px;">No attachments yet.</div>`}
        </div>
        <div class="attachment-upload-area">
          <input type="file" id="attachment-file-input" style="display:none;" onchange="uploadAttachment(${id})" />
          <button class="btn-upload" id="attach-upload-btn"
            onclick="document.getElementById('attachment-file-input').click()"
            ${attachments.length >= 5 ? 'disabled' : ''}>+ Attach File</button>
          <span class="attachment-count" ${attachments.length >= 5 ? 'style="color:#cc0000;"' : ''}>
            ${attachments.length >= 5 ? 'Maximum 5 attachments reached' : `${5 - attachments.length} remaining`}
          </span>
        </div>
      </div>`;

    document.getElementById('edit-issue-btn').onclick   = () => openEditModal(issue);
    document.getElementById('delete-issue-btn').onclick = () => deleteIssue(id);

  } catch (e) {
    document.getElementById('issue-detail-body').innerHTML = `<div class="empty-state"><div class="es-icon">‚ö†Ô∏è</div><div class="es-title">Failed to load issue</div></div>`;
  }
}

function attachmentHTML(a, issueId) {
  return `<div class="attachment-item" id="att-${a.id}">
    <span class="attachment-icon">${getFileIcon(a.file_type || a.fileType)}</span>
    <span class="attachment-name">${escHtml(a.original_name || a.originalName)}</span>
    <span class="attachment-size">${formatSize(a.file_size || a.fileSize)}</span>
    <a class="attachment-download" href="${API}/download_attachment.php?id=${a.id}" target="_blank">‚¨á Download</a>
    <button class="attachment-delete" onclick="deleteAttachment(${a.id}, ${issueId})">‚úï</button>
  </div>`;
}

// ============================================================
// COMMENTS
// ============================================================
async function addComment() {
  const userSel = document.getElementById('comment-user-select');
  const textEl  = document.getElementById('comment-text');
  if (!userSel || !textEl) return;

  const userId  = userSel.value;
  const author  = userSel.options[userSel.selectedIndex].text;
  const comment = textEl.value.trim();
  if (!comment) return;

  try {
    const res = await apiFetch('/add_comment.php', {
      method: 'POST',
      body: JSON.stringify({ issueId: currentIssueId, userId, author, comment })
    });
    if (res.success) {
      toast('Comment added!', 'success');
      textEl.value = '';
      viewIssue(currentIssueId);
    } else {
      toast(res.message || 'Failed to add comment.', 'error');
    }
  } catch { toast('Failed to save comment.', 'error'); }
}

// ============================================================
// EDIT
// ============================================================
function openEditModal(issue) {
  document.getElementById('edit-state').value              = issue.state;
  document.getElementById('edit-priority').value           = issue.priority;
  document.getElementById('edit-story-points').value       = issue.storyPoints || issue.story_points || '';
  document.getElementById('edit-iteration-path').value     = issue.iterationPath || issue.iteration_path || '';
  document.getElementById('edit-area-path').value          = issue.areaPath || issue.area_path || '';
  document.getElementById('edit-acceptance-criteria').value= issue.acceptanceCriteria || issue.acceptance_criteria || '';
  const sel = document.getElementById('edit-assigned-to');
  sel.value = issue.assigned_to || issue.assignedTo || '';
  openModal('edit-issue-modal');
}

async function saveEdit() {
  const dto = {
    state:               document.getElementById('edit-state').value,
    priority:            document.getElementById('edit-priority').value,
    storyPoints:         document.getElementById('edit-story-points').value || null,
    assignedTo:          document.getElementById('edit-assigned-to').value  || null,
    iterationPath:       document.getElementById('edit-iteration-path').value,
    areaPath:            document.getElementById('edit-area-path').value,
    acceptanceCriteria:  document.getElementById('edit-acceptance-criteria').value,
  };

  try {
    // FIX: id passed as query param, not path segment
    const res = await apiFetch(`/update_issue.php?id=${currentIssueId}`, { method: 'POST', body: JSON.stringify(dto) });
    if (res.success) {
      closeModal('edit-issue-modal');
      toast('Issue updated!', 'success');
      viewIssue(currentIssueId);
      loadDashboard();
      if (document.getElementById('view-issues').classList.contains('active')) loadIssues();
    } else {
      toast(res.message || 'Update failed.', 'error');
    }
  } catch { toast('Update failed.', 'error'); }
}

// ============================================================
// DELETE
// ============================================================
async function deleteIssue(id) {
  if (!confirm('Delete this issue? This cannot be undone.')) return;
  try {
    // FIX: id as query param, GET method (PHP reads $_GET)
    const res = await apiFetch(`/delete_issue.php?id=${id}`, { method: 'GET' });
    if (res.success) {
      closeModal('issue-detail-modal');
      toast('Issue deleted.', 'info');
      loadDashboard();
      if (document.getElementById('view-issues').classList.contains('active')) loadIssues();
    } else {
      toast(res.message || 'Delete failed.', 'error');
    }
  } catch { toast('Delete failed.', 'error'); }
}

// ============================================================
// NEW ISSUE
// ============================================================
async function submitNewIssue(e) {
  e.preventDefault();
  const btn = document.getElementById('ni-submit-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loader"></div> Saving‚Ä¶';

  const dto = {
    title:               document.getElementById('ni-title').value.trim()               || null,
    dashboard:           document.getElementById('ni-dashboard').value.trim()           || null,
    module:              document.getElementById('ni-module').value.trim()              || null,
    description:         document.getElementById('ni-desc').value.trim(),
    state:               document.getElementById('ni-state').value                      || 'Draft',
    priority:            document.getElementById('ni-priority').value                   || '4-Medium',
    storyPoints:         document.getElementById('ni-story-points').value               || null,
    areaPath:            document.getElementById('ni-area-path').value.trim()           || null,
    iterationPath:       document.getElementById('ni-iteration-path').value.trim()      || null,
    acceptanceCriteria:  document.getElementById('ni-acceptance-criteria').value.trim() || null,
    issuedBy:            parseInt(document.getElementById('ni-issued-by').value)        || null,
    assignedTo:          parseInt(document.getElementById('ni-assigned-to').value)      || null,
    dateIdentified:      document.getElementById('ni-date').value,
  };

  try {
    const res = await apiFetch('/create_issue.php', { method: 'POST', body: JSON.stringify(dto) });
    if (res.success) {
      toast('Issue created successfully!', 'success');
      document.getElementById('new-issue-form').reset();
      setTodayDate();
      loadDashboard();
      navigate('issues');
    } else {
      toast(res.message || 'Failed to create issue.', 'error');
    }
  } catch {
    toast('Failed to create issue.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Issue';
  }
}

function setTodayDate() {
  const d = document.getElementById('ni-date');
  if (d) d.value = new Date().toISOString().split('T')[0];
}

// ============================================================
// IMPORT CSV ‚Äî FIX: points to import_csv.php
// ============================================================
let selectedFile = null;

function handleFileSelect(e) { setFile(e.target.files[0]); }
function setFile(file) {
  selectedFile = file;
  document.getElementById('file-name-display').textContent = file.name;
  document.getElementById('file-size-display').textContent = (file.size / 1024).toFixed(1) + ' KB';
  document.getElementById('file-preview').style.display = '';
}
function clearFile() {
  selectedFile = null;
  document.getElementById('file-preview').style.display = 'none';
  document.getElementById('csv-file').value = '';
}

async function doImport() {
  if (!selectedFile) { toast('Please select a CSV file.', 'error'); return; }
  const userId = document.getElementById('import-user').value;
  const btn    = document.getElementById('import-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loader"></div> Importing‚Ä¶';

  const form = new FormData();
  form.append('file', selectedFile);
  if (userId) form.append('importedBy', userId);

  try {
    // FIX: points to the new import_csv.php endpoint
    const res  = await fetch(`${API}/import_csv.php`, { method: 'POST', body: form });
    const data = await res.json();
    const result = document.getElementById('import-result');
    result.style.display = '';

    if (data.success) {
      result.innerHTML = `<div style="background:rgba(46,158,107,0.1);border:1px solid rgba(46,158,107,0.3);border-radius:8px;padding:14px 18px;">
        <div style="font-weight:700;color:var(--success);margin-bottom:6px;">‚úÖ ${escHtml(data.message)}</div>
        ${data.data?.errors?.length ? `<div style="font-size:11px;color:var(--text-dim);">${data.data.errors.slice(0,5).map(e => `<div>‚ö† ${escHtml(e)}</div>`).join('')}</div>` : ''}
      </div>`;
      toast(data.message, 'success');
      clearFile();
      loadDashboard();
    } else {
      result.innerHTML = `<div style="background:rgba(217,79,79,0.1);border:1px solid rgba(217,79,79,0.3);border-radius:8px;padding:14px 18px;color:var(--danger);">‚ùå ${escHtml(data.message || 'Import failed.')}</div>`;
      toast('Import failed.', 'error');
    }
  } catch {
    toast('Could not connect to API.', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üì• Import File';
  }
}

// ============================================================
// REPORTS
// ============================================================
async function generateReport() {
  const dto = {
    dateRange:    document.getElementById('rpt-date-range').value,
    statusFilter: document.getElementById('rpt-status-filter').value
  };
  try {
    const res = await apiFetch('/create_report.php', { method:'POST', body:JSON.stringify(dto) });
    const r   = res.data;
    currentReportId = r.id;

    document.getElementById('report-grid').innerHTML = [
      ['Total Issues',r.totalIssues,'üì¶'],['New',r.newCount,'üÜï'],['Bugs',r.bugCount,'üêõ'],
      ['Open',r.openCount,'üìÇ'],['In Progress',r.inProgressCount,'‚öô'],['Resolved',r.resolvedCount,'‚úÖ']
    ].map(([label,val,icon]) => `
      <div class="report-stat-box">
        <div><div class="rs-label">${label}</div><div class="rs-val">${val}</div></div>
        <div style="font-size:28px;opacity:0.3;">${icon}</div>
      </div>`).join('');

    document.getElementById('latest-report-section').style.display = '';
    document.getElementById('export-report-btn').onclick = () => window.open(`${API}/download_report.php?id=${r.id}`, '_blank');
    toast('Report generated!', 'success');
    loadReportHistory();
  } catch { }
}

async function loadReportHistory() {
  try {
    const res  = await apiFetch('/get_reports.php');
    const list = res.data || [];
    document.getElementById('report-history').innerHTML = list.length
      ? list.map(r => `
        <div class="report-history-item">
          <div class="rh-icon">üìã</div>
          <div class="rh-info">
            <div class="rh-title">${escHtml(r.date_range||'Custom')} ‚Äî ${escHtml(r.status_filter)}</div>
            <div class="rh-sub">${r.total_issues||0} issues ¬∑ ${fmtDateTime(r.generated_at)}</div>
          </div>
          <button class="btn btn-success btn-xs" onclick="window.open('${API}/download_report.php?id=${r.id}','_blank')">‚¨á CSV</button>
        </div>`).join('')
      : `<div class="empty-state"><div class="es-icon">üìã</div><div class="es-title">No reports yet</div><div class="es-sub">Generate your first report above.</div></div>`;
  } catch { }
}

function exportIssues() {
  const state    = document.getElementById('filter-state')?.value    || '';
  const priority = document.getElementById('filter-priority')?.value || '';
  const search   = document.getElementById('global-search')?.value   || '';
  const params   = new URLSearchParams();
  if (state)    params.set('state', state);
  if (priority) params.set('priority', priority);
  if (search)   params.set('search', search);
  window.open(`${API}/export_issues_excel.php?${params}`, '_blank');
}

// ============================================================
// ATTACHMENTS
// ============================================================
async function uploadAttachment(issueId) {
  const input = document.getElementById('attachment-file-input');
  const file  = input.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res  = await fetch(`${API}/attachments.php?issueId=${issueId}`, { method:'POST', body:formData });
    const data = await res.json();
    if (data.success) {
      toast('File attached!', 'success');
      await refreshAttachments(issueId);
    } else {
      toast(data.message || 'Upload failed.', 'error');
    }
  } catch {
    toast('Upload failed.', 'error');
  }
  input.value = '';
}

async function refreshAttachments(issueId) {
  const aRes        = await apiFetch(`/attachments.php?issueId=${issueId}`);
  const attachments = aRes.data || [];
  const list        = document.getElementById('attachment-list');
  if (!list) return;

  list.innerHTML = attachments.length
    ? attachments.map(a => attachmentHTML(a, issueId)).join('')
    : `<div style="color:#aaa;font-size:12px;">No attachments yet.</div>`;

  const uploadBtn = document.getElementById('attach-upload-btn');
  if (uploadBtn) uploadBtn.disabled = attachments.length >= 5;
  const countSpan = document.querySelector('.attachment-count');
  if (countSpan) {
    countSpan.textContent = attachments.length >= 5 ? 'Maximum 5 attachments reached' : `${5 - attachments.length} remaining`;
    countSpan.style.color = attachments.length >= 5 ? '#cc0000' : '';
  }
  const header = document.querySelector('.attachments-header');
  if (header) header.textContent = `üìé Attachments (${attachments.length}/5)`;
}

async function deleteAttachment(attachmentId, issueId) {
  if (!confirm('Remove this attachment?')) return;
  try {
    // FIX: uses the new delete_attachment.php with correct params
    const res  = await fetch(`${API}/delete_attachment.php?issueId=${issueId}&attachmentId=${attachmentId}`);
    const data = await res.json();
    if (data.success) {
      toast('Attachment removed.', 'success');
      await refreshAttachments(issueId);
    } else {
      toast(data.message || 'Failed.', 'error');
    }
  } catch { toast('Failed to remove attachment.', 'error'); }
}

// ============================================================
// MODALS
// ============================================================
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('open'); });
});

// ============================================================
// TOAST
// ============================================================
function toast(message, type = 'info') {
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚Ñπ' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${icons[type]}</span><span>${escHtml(message)}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3800);
}

// ============================================================
// HELPERS
// ============================================================
function stateBadge(state) {
  const map = {
    // PDF states
    'Draft':'badge-draft','For Review':'badge-forreview','Approved':'badge-approved',
    'In Development':'badge-indev','For Testing':'badge-fortesting','QA Failed':'badge-qafailed',
    'For UAT':'badge-foruat','Ready for Deployment':'badge-readydeploy','Deployed':'badge-deployed','Closed':'badge-closed',
    // Legacy
    'New':'badge-new','Bug':'badge-bug','Open':'badge-open','In Progress':'badge-inprogress','Resolved':'badge-resolved'
  };
  return `<span class="badge ${map[state]||'badge-new'}">${escHtml(state)}</span>`;
}

function priBadge(p) {
  if (!p) return '‚Äî';
  const map = {
    '1-Urgent':'pri-1urgent','2-Critical':'pri-2critical','3-High':'pri-3high','4-Medium':'pri-4medium','5-Low':'pri-5low',
    'Critical':'pri-critical','High':'pri-high','Medium':'pri-medium','Low':'pri-low'
  };
  const label = p.includes('-') ? p.split('-').slice(1).join('-') : p;
  return `<span class="pri-badge ${map[p]||'pri-4medium'}">${escHtml(label)}</span>`;
}

function spHours(sp) {
  const map = { '1':'1‚Äì2 hrs','2':'3‚Äì4 hrs','3':'5‚Äì8 hrs','5':'8‚Äì16 hrs','8':'24‚Äì32 hrs','13':'40‚Äì56 hrs' };
  return map[sp] ? `‚âà ${map[sp]}` : '';
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-PH', { year:'numeric', month:'short', day:'2-digit' });
}
function fmtDateTime(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleString('en-PH', { month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function emptyRow(cols, msg) {
  return `<tr><td colspan="${cols}"><div class="empty-state"><div class="es-icon">üîç</div><div class="es-title">${escHtml(msg)}</div></div></td></tr>`;
}
function getFileIcon(fileType) {
  if (!fileType) return 'üìÑ';
  if (fileType.startsWith('image/')) return 'üñºÔ∏è';
  if (fileType === 'application/pdf') return 'üìï';
  if (fileType.includes('word')) return 'üìù';
  if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
  return 'üìÑ';
}
function formatSize(bytes) {
  if (!bytes) return '';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}
</script>
</body>
</html>
