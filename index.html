<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Issue Tracker ‚Äî Enterprise</title>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:       #ffffff;
  --navy-mid:   #cc0000;
  --navy-light: #e60000;
  --steel:      #ffcccc;
  --accent:     #cc0000;
  --accent-dim: #aa0000;
  --sky:        #cc0000;
  --danger:     #990000;
  --success:    #2e9e6b;
  --warn:       #e07b20;
  --info:       #cc0000;
  --text-bright:#1a1a1a;
  --text-main:  #333333;
  --text-dim:   #888888;
  --border:     rgba(204,0,0,0.15);
  --card-bg:    rgba(255,255,255,0.98);
  --glass:      rgba(255,255,255,0.97);
  --sidebar-w:  240px;
  --topbar-h:   60px;
  --radius:     10px;
  --radius-lg:  14px;
}

html { font-size: 14px; scroll-behavior: smooth; }
body {
  font-family: 'Raleway', sans-serif;
  background: #f5f5f5;
  color: var(--text-main);
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--steel); border-radius: 99px; }

/* ===== SIDEBAR ===== */
#sidebar {
  width: var(--sidebar-w);
  min-height: 100vh;
  background: var(--navy-mid);
  border-right: none;
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0; top: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
}

.sidebar-logo {
  padding: 22px 20px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}
.sidebar-logo .logo-mark {
  display: flex;
  align-items: center;
  gap: 10px;
}
.logo-icon {
  width: 36px; height: 36px;
  background: #ffffff;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.logo-text {
  font-size: 14px;
  font-weight: 700;
  color: #ffffff;
  line-height: 1.2;
}
.logo-sub {
  font-size: 10px;
  color: rgba(255,255,255,0.75);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-family: 'Roboto Mono', monospace;
}

.sidebar-nav {
  flex: 1;
  padding: 16px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.nav-section-label {
  font-size: 9.5px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.6);
  font-family: 'Roboto Mono', monospace;
  padding: 12px 8px 6px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  color: rgba(255,255,255,0.85);
  font-size: 13.5px;
  font-weight: 500;
  user-select: none;
  text-decoration: none;
}
.nav-item:hover { background: rgba(255,255,255,0.15); color: #ffffff; }
.nav-item.active {
  background: rgba(255,255,255,0.2);
  color: #ffffff;
  border-left: 3px solid #ffffff;
  padding-left: 9px;
}
.nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
.nav-badge {
  margin-left: auto;
  background: var(--danger);
  color: #fff;
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 99px;
  font-family: 'Roboto Mono', monospace;
}

.sidebar-footer {
  padding: 14px 20px;
  border-top: 1px solid rgba(255,255,255,0.2);
  font-size: 11px;
  color: rgba(255,255,255,0.6);
  font-family: 'Roboto Mono', monospace;
}

/* ===== MAIN LAYOUT ===== */
#main {
  margin-left: var(--sidebar-w);
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* ===== TOPBAR ===== */
#topbar {
  height: var(--topbar-h);
  background: var(--glass);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 16px;
  position: sticky;
  width: 100%;
  box-sizing: border-box;
  top: 0;
  z-index: 90;
}

.topbar-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-bright);
}
.topbar-sep { flex: 1; }

.topbar-search {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 14px;
  width: 220px;
  flex-shrink: 0;
}
.topbar-search input {
  background: transparent;
  border: none;
  outline: none;
  color: var(--text-main);
  font-family: 'Raleway', sans-serif;
  font-size: 13px;
  width: 100%;
}
.topbar-search input::placeholder { color: var(--text-dim); }

.topbar-btn {
  display: flex; align-items: center; gap: 7px;
  background: var(--accent);
  color: var(--navy);
  font-weight: 700;
  font-size: 12.5px;
  border: none;
  border-radius: 8px;
  padding: 7px 16px;
  cursor: pointer;
  transition: background 0.2s;
  font-family: 'Raleway', sans-serif;
}
.topbar-btn:hover { background: var(--accent-dim); }

/* ===== CONTENT ===== */
#content {
  flex: 1;
  padding: 28px 28px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* ===== VIEWS ===== */
.view { display: none; flex-direction: column; gap: 24px; }
.view.active { display: flex; }

/* ===== STAT CARDS ===== */
.stat-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 14px;
}
.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, transform 0.2s;
  backdrop-filter: blur(8px);
}
.stat-card:hover { transform: translateY(-2px); border-color: rgba(74,158,206,0.4); }
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px; height: 100%;
}
.stat-card.c-total::before  { background: var(--sky); }
.stat-card.c-new::before    { background: var(--info); }
.stat-card.c-bug::before    { background: var(--danger); }
.stat-card.c-open::before   { background: var(--warn); }
.stat-card.c-prog::before   { background: var(--accent); }
.stat-card.c-res::before    { background: var(--success); }

.stat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  font-family: 'Roboto Mono', monospace;
  margin-bottom: 6px;
}
.stat-value {
  font-size: 30px;
  font-weight: 700;
  color: var(--text-bright);
  line-height: 1;
}
.stat-icon {
  position: absolute;
  right: 16px; top: 50%;
  transform: translateY(-50%);
  font-size: 28px;
  opacity: 0.12;
}

/* ===== CARDS ===== */
.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(8px);
  overflow: hidden;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-bright);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-family: 'Roboto Mono', monospace;
}
.card-header .sep { flex: 1; }
.card-body { padding: 20px; }

/* ===== CHARTS ROW ===== */
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1.5fr;
  gap: 16px;
}
.chart-container {
  position: relative;
  height: 220px;
}

/* ===== TABLE ===== */
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
thead th {
  padding: 10px 14px;
  text-align: left;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-dim);
  font-family: 'Roboto Mono', monospace;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid rgba(74,158,206,0.07);
  transition: background 0.15s;
  cursor: pointer;
}
tbody tr:hover { background: rgba(74,158,206,0.07); }
tbody td {
  padding: 11px 14px;
  color: var(--text-main);
  vertical-align: middle;
}
.td-desc {
  max-width: 320px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-bright);
}
.td-id {
  font-family: 'Roboto Mono', monospace;
  color: var(--text-dim);
  font-size: 11px;
}
.td-date {
  font-family: 'Roboto Mono', monospace;
  font-size: 11px;
  white-space: nowrap;
}

/* ===== BADGES ===== */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 10.5px;
  font-weight: 600;
  letter-spacing: 0.04em;
  white-space: nowrap;
}
.badge-new        { background: rgba(74,158,206,0.15); color: var(--sky); border: 1px solid rgba(74,158,206,0.3); }
.badge-bug        { background: rgba(217,79,79,0.15);  color: var(--danger); border: 1px solid rgba(217,79,79,0.3); }
.badge-open       { background: rgba(224,123,32,0.15); color: var(--warn); border: 1px solid rgba(224,123,32,0.3); }
.badge-inprogress { background: rgba(232,160,32,0.15); color: var(--accent); border: 1px solid rgba(232,160,32,0.3); }
.badge-resolved   { background: rgba(46,158,107,0.15); color: var(--success); border: 1px solid rgba(46,158,107,0.3); }

.pri-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'Roboto Mono', monospace;
}
.pri-critical { background: rgba(217,79,79,0.2);  color: #f08080; }
.pri-high     { background: rgba(224,123,32,0.2); color: var(--warn); }
.pri-medium   { background: rgba(232,160,32,0.2); color: var(--accent); }
.pri-low      { background: rgba(46,158,107,0.2); color: var(--success); }

/* ===== ACTION BUTTONS ===== */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px;
  border-radius: 7px;
  font-family: 'Raleway', sans-serif;
  font-size: 12.5px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}
.btn-primary   { background: #ffffff; color: #000000; border: 1px solid #cccccc; }
.btn-primary:hover { background: #f0f0f0; color: #000000; }
.btn-ghost     { background: #ffffff; color: #000000; border: 1px solid #cccccc; }
.btn-ghost:hover { background: #f0f0f0; color: #000000; border-color: #999; }
.btn-danger    { background: #ffffff; color: #000000; border: 1px solid #cccccc; }
.btn-danger:hover { background: #f0f0f0; color: #000000; }
.btn-success   { background: rgba(46,158,107,0.15); color: var(--success); border: 1px solid rgba(46,158,107,0.3); }
.btn-success:hover { background: rgba(46,158,107,0.25); }
.btn-sm { padding: 5px 10px; font-size: 11.5px; }
.btn-xs { padding: 3px 8px; font-size: 10.5px; }

/* ===== FILTER BAR ===== */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.filter-select {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text-main);
  padding: 6px 12px;
  font-family: 'Raleway', sans-serif;
  font-size: 12.5px;
  cursor: pointer;
  outline: none;
  transition: border-color 0.2s;
}
.filter-select:hover, .filter-select:focus { border-color: rgba(74,158,206,0.5); }
.filter-select option { background: #ffffff; color: #333333; }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 540px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
}
.modal-title {
  font-size: 14px;
  font-weight: 700;
  color: #cc0000;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-family: 'Roboto Mono', monospace;
}
.modal-close {
  margin-left: auto;
  background: transparent;
  border: none;
  color: #888888;
  font-size: 20px;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}
.modal-close:hover { color: #333333; }
.modal-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; color: #333333; }
.modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end; }

/* ===== FORM ===== */
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
label {
  font-size: 10.5px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  font-family: 'Roboto Mono', monospace;
}
input[type="text"], input[type="email"], input[type="date"],
textarea, select.form-control {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text-bright);
  font-family: 'Raleway', sans-serif;
  font-size: 13px;
  padding: 9px 12px;
  width: 100%;
  outline: none;
  transition: border-color 0.2s;
}
input[type="text"]:focus, input[type="email"]:focus, input[type="date"]:focus,
textarea:focus, select.form-control:focus {
  border-color: var(--sky);
}
textarea { resize: vertical; min-height: 80px; }
select.form-control option { background: #ffffff; color: #333333; }

/* ===== ISSUE DETAIL PANEL ===== */
.detail-panel {
  display: grid;
  grid-template-columns: 1.4fr 1fr;
  gap: 20px;
}
.detail-meta { display: flex; flex-direction: column; gap: 10px; }
.meta-row { display: flex; align-items: flex-start; gap: 10px; }
.meta-key {
  font-size: 10.5px;
  font-weight: 600;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  text-transform: uppercase;
  font-family: 'Roboto Mono', monospace;
  min-width: 90px;
  padding-top: 2px;
}
.meta-val { color: var(--text-bright); font-size: 13px; }

.comments-section { display: flex; flex-direction: column; gap: 10px; }
.comment-item {
  background: #f8f8f8;
  border: 1px solid #eeeeee;
  border-radius: 8px;
  padding: 10px 14px;
}
.comment-author { font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 3px; }
.comment-time   { font-size: 10px; color: var(--text-dim); font-family: 'Roboto Mono', monospace; float: right; }
.comment-text   { font-size: 12.5px; color: var(--text-main); }

.comment-input-row {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}
.comment-input-row textarea {
  flex: 1;
  min-height: 50px;
  resize: none;
}

/* ===== IMPORT SECTION ===== */
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: #fafafa;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--sky);
  background: rgba(74,158,206,0.05);
}
.drop-zone .dz-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
.drop-zone .dz-title { font-size: 15px; font-weight: 600; color: var(--text-bright); margin-bottom: 4px; }
.drop-zone .dz-sub   { font-size: 12px; color: var(--text-dim); }

/* ===== REPORT PAGE ===== */
.report-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.report-stat-box {
  background: #f8f8f8;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.report-stat-box .rs-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; font-family: 'Roboto Mono', monospace; }
.report-stat-box .rs-val   { font-size: 26px; font-weight: 700; color: var(--text-bright); }

.report-history-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.report-history-item:last-child { border-bottom: none; }
.rh-icon { font-size: 22px; }
.rh-info { flex: 1; }
.rh-title { font-size: 13px; font-weight: 600; color: var(--text-bright); }
.rh-sub   { font-size: 11px; color: var(--text-dim); font-family: 'Roboto Mono', monospace; }

/* ===== TOAST ===== */
#toast-container {
  position: fixed;
  bottom: 24px; right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.toast {
  background: var(--navy-mid);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-bright);
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: toastIn 0.3s ease;
  min-width: 260px;
  max-width: 380px;
}
.toast.success { border-left: 3px solid var(--success); }
.toast.error   { border-left: 3px solid var(--danger); }
.toast.info    { border-left: 3px solid var(--sky); }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* ===== LOADER ===== */
.loader {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.15);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-state .es-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
.empty-state .es-title { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
.empty-state .es-sub   { font-size: 12.5px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) {
  .charts-row { grid-template-columns: 1fr; }
  .detail-panel { grid-template-columns: 1fr; }
  .report-grid { grid-template-columns: 1fr; }
}
@media (max-width: 700px) {
  #sidebar { transform: translateX(-100%); }
  #sidebar.open { transform: translateX(0); }
  #main { margin-left: 0; }
  .form-row { grid-template-columns: 1fr; }
}

/* ===== ATTACHMENTS ===== */
.attachments-section {
  margin-top: 16px;
  border-top: 1px solid #eee;
  padding-top: 14px;
}
.attachments-header {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #888;
  font-family: 'Roboto Mono', monospace;
  margin-bottom: 10px;
}
.attachment-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}
.attachment-item {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #f8f8f8;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 12px;
}
.attachment-icon { font-size: 18px; flex-shrink: 0; }
.attachment-name { flex: 1; font-weight: 600; color: #333; word-break: break-all; }
.attachment-size { color: #aaa; font-family: 'Roboto Mono', monospace; font-size: 10px; flex-shrink: 0; }
.attachment-download {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 3px 10px;
  font-size: 11px;
  cursor: pointer;
  color: #333;
  text-decoration: none;
  flex-shrink: 0;
}
.attachment-download:hover { background: #f0f0f0; }
.attachment-delete {
  background: #fff;
  border: 1px solid #ffcccc;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 11px;
  cursor: pointer;
  color: #cc0000;
  flex-shrink: 0;
}
.attachment-delete:hover { background: #fff0f0; }
.attachment-upload-area {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.attachment-count {
  font-size: 11px;
  color: #888;
  font-family: 'Roboto Mono', monospace;
}
.btn-upload {
  background: #fff;
  border: 1px dashed #cc0000;
  border-radius: 8px;
  padding: 7px 16px;
  font-size: 12px;
  cursor: pointer;
  color: #cc0000;
  font-family: 'Raleway', sans-serif;
  font-weight: 600;
  transition: all 0.2s;
}
.btn-upload:hover { background: #fff0f0; }
.btn-upload:disabled { opacity: 0.5; cursor: not-allowed; }

</style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <div class="logo-icon">üõ°</div>
      <div>
        <div class="logo-text">IssueTracker</div>
        <div class="logo-sub">Enterprise v1.0</div>
      </div>
    </div>
  </div>

  <div class="sidebar-nav">
    <div class="nav-section-label">Main</div>
    <a class="nav-item active" data-view="dashboard">
      <span class="icon">üìä</span> Dashboard
    </a>
    <a class="nav-item" data-view="issues">
      <span class="icon">üîé</span> All Issues
      <span class="nav-badge" id="badge-open">‚Äì</span>
    </a>

    <div class="nav-section-label">Management</div>
    <a class="nav-item" data-view="new-issue">
      <span class="icon">‚ûï</span> New Issue
    </a>
    <a class="nav-item" data-view="import">
      <span class="icon">üì•</span> Import CSV
    </a>

    <div class="nav-section-label">Analytics</div>
    <a class="nav-item" data-view="reports">
      <span class="icon">üìã</span> Reports
    </a>
  </div>

  <div class="sidebar-footer">
  API: <span style="color:var(--text-dim)">localhost/issuetracker</span>
</div>
</nav>

<!-- ===== MAIN ===== -->
<div id="main">

  <!-- TOPBAR -->
  <div id="topbar">
    <div class="topbar-title" id="topbar-title">Dashboard</div>
    <div class="topbar-sep"></div>
    <div class="topbar-search">
      <span>üîç</span>
      <input type="text" id="global-search" placeholder="Search issues‚Ä¶" />
    </div>
    <button class="topbar-btn" onclick="openNewIssueModal()">
      ‚ûï New Issue
    </button>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- ===== DASHBOARD VIEW ===== -->
    <div class="view active" id="view-dashboard">
      <!-- Stat Row -->
      <div class="stat-row" id="stat-row">
        <div class="stat-card c-total"><div class="stat-label">Total</div><div class="stat-value" id="s-total">‚Äì</div><div class="stat-icon">üì¶</div></div>
        <div class="stat-card c-new"><div class="stat-label">New</div><div class="stat-value" id="s-new">‚Äì</div><div class="stat-icon">üÜï</div></div>
        <div class="stat-card c-bug"><div class="stat-label">Bugs</div><div class="stat-value" id="s-bug">‚Äì</div><div class="stat-icon">üêõ</div></div>
        <div class="stat-card c-open"><div class="stat-label">Open</div><div class="stat-value" id="s-open">‚Äì</div><div class="stat-icon">üìÇ</div></div>
        <div class="stat-card c-prog"><div class="stat-label">In Progress</div><div class="stat-value" id="s-prog">‚Äì</div><div class="stat-icon">‚öô</div></div>
        <div class="stat-card c-res"><div class="stat-label">Resolved</div><div class="stat-value" id="s-res">‚Äì</div><div class="stat-icon">‚úÖ</div></div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="card">
          <div class="card-header"><div class="card-title">Issues by Priority</div></div>
          <div class="card-body"><div class="chart-container"><canvas id="chart-priority"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Issues by Dashboard</div></div>
          <div class="card-body"><div class="chart-container"><canvas id="chart-dashboard"></canvas></div></div>
        </div>
      </div>

      <!-- Recent Issues Table -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Issues</div>
          <div class="sep"></div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('issues')">View All ‚Üí</button>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrapper">
            <table id="recent-issues-table">
              <thead>
                <tr>
                  <th>#</th><th>Dashboard</th><th>Description</th>
                  <th>State</th><th>Priority</th><th>Issued By</th><th>Date</th><th></th>
                </tr>
              </thead>
              <tbody id="recent-issues-body">
                <tr><td colspan="8"><div class="empty-state"><div class="loader"></div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ALL ISSUES VIEW ===== -->
    <div class="view" id="view-issues">
      <div class="card">
        <div class="card-header">
          <div class="card-title">All Issues</div>
          <div class="sep"></div>
          <!-- Filters -->
          <div class="filter-bar">
            <select class="filter-select" id="filter-state" onchange="loadIssues()">
              <option value="">All States</option>
              <option>New</option><option>Bug</option><option>Open</option>
              <option>In Progress</option><option>Resolved</option>
            </select>
            <select class="filter-select" id="filter-priority" onchange="loadIssues()">
              <option value="">All Priorities</option>
              <option>Critical</option><option>High</option>
              <option>Medium</option><option>Low</option>
            </select>
            <button class="btn btn-ghost btn-sm" onclick="exportIssues()">‚¨á Export Excel</button>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Dashboard</th><th>Module</th><th>Description</th>
                  <th>State</th><th>Priority</th><th>Issued By</th><th>Date</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="issues-body">
                <tr><td colspan="9"><div class="empty-state"><div class="loader"></div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== NEW ISSUE VIEW ===== -->
    <div class="view" id="view-new-issue">
  <div class="card" style="width: 100%; max-width: none;">
        <div class="card-header"><div class="card-title">Log New Issue</div></div>
        <div class="card-body">
          <form id="new-issue-form" onsubmit="submitNewIssue(event)" style="display:flex;flex-direction:column;gap:16px;">
            <div class="form-row">
              <div class="form-group">
                <label>Dashboard</label>
                <input type="text" id="ni-dashboard" placeholder="e.g. MSP Dashboard" />
              </div>
              <div class="form-group">
                <label>Module</label>
                <input type="text" id="ni-module" placeholder="e.g. Inventory" />
              </div>
            </div>
            <div class="form-group">
              <label>Description *</label>
              <textarea id="ni-desc" placeholder="Describe the issue in detail‚Ä¶" rows="4" required></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>State</label>
                <select class="form-control" id="ni-state">
                  <option>New</option><option>Bug</option><option>Open</option>
                  <option>In Progress</option><option>Resolved</option>
                </select>
              </div>
              <div class="form-group">
                <label>Priority</label>
                <select class="form-control" id="ni-priority">
                  <option>Low</option><option selected>Medium</option>
                  <option>High</option><option>Critical</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Issued By</label>
                <select class="form-control" id="ni-issued-by">
                  <option value="">‚Äî Select ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <label>Assigned To</label>
                <select class="form-control" id="ni-assigned-to">
                  <option value="">‚Äî Unassigned ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Date Identified</label>
              <input type="date" id="ni-date" />
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:6px;">
              <button type="button" class="btn btn-ghost" onclick="navigate('issues')">Cancel</button>
              <button type="submit" class="btn btn-primary" id="ni-submit-btn">Create Issue</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== IMPORT VIEW ===== -->
    <div class="view" id="view-import">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Import CSV File</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="drop-zone" id="drop-zone" onclick="document.getElementById('csv-file').click()">
              <div class="dz-icon">üìÇ</div>
              <div class="dz-title">Drop CSV file here</div>
              <div class="dz-sub">or click to browse ‚Äî Max 10MB</div>
              <input type="file" id="csv-file" accept=".csv" style="display:none" onchange="handleFileSelect(event)" />
            </div>
            <div id="file-preview" style="display:none;">
              <div style="background:rgba(46,158,107,0.1);border:1px solid rgba(46,158,107,0.3);border-radius:8px;padding:12px 16px;display:flex;align-items:center;gap:10px;">
                <span style="font-size:22px;">üìÑ</span>
                <div>
                  <div style="font-weight:600;color:var(--text-bright)" id="file-name"></div>
                  <div style="font-size:11px;color:var(--text-dim)" id="file-size"></div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="clearFile()" style="margin-left:auto;">‚úï</button>
              </div>
            </div>
            <div class="form-group">
              <label>Imported By</label>
              <select class="form-control" id="import-user">
                <option value="">‚Äî Select User ‚Äî</option>
              </select>
            </div>
            <button class="btn btn-primary" id="import-btn" onclick="doImport()">
              üì• Import File
            </button>
            <div id="import-result" style="display:none;"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">CSV Format Guide</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
            <p style="font-size:12.5px;color:var(--text-dim);">Your CSV file should follow the same column structure as the Excel export. Required columns:</p>
            <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:14px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text-main);line-height:1.8;overflow-x:auto;">
              ID, Description, State, Date Identified:, Issued by:
            </div>
            <p style="font-size:12.5px;color:var(--text-dim);">Description format for best results:</p>
            <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:14px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:#cc0000;line-height:2;overflow-x:auto;">
              MSP Dashboard | Inventory | Issue description here
            </div>
            <p style="font-size:11.5px;color:var(--text-dim);">
              Valid states: <span style="color:#cc0000">New, Bug, Open, In Progress, Resolved</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== REPORTS VIEW ===== -->
    <div class="view" id="view-reports">
      <!-- Generate Report -->
      <div class="card">
        <div class="card-header"><div class="card-title">Generate Report</div></div>
        <div class="card-body" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
          <div class="form-group" style="min-width:160px;">
            <label>Date Range</label>
            <select class="form-control" id="rpt-date-range">
              <option>Last 7 Days</option>
              <option selected>Last 30 Days</option>
              <option>Last 90 Days</option>
              <option>This Year</option>
            </select>
          </div>
          <div class="form-group" style="min-width:160px;">
            <label>Status Filter</label>
            <select class="form-control" id="rpt-status-filter">
              <option>All Statuses</option>
              <option>New</option><option>Bug</option><option>Open</option>
              <option>In Progress</option><option>Resolved</option>
            </select>
          </div>
          <div style="align-self:flex-end;padding-bottom:2px;">
            <button class="btn btn-primary" onclick="generateReport()">‚ö° Generate Report</button>
          </div>
        </div>
      </div>

      <!-- Latest Report Stats -->
      <div id="latest-report-section" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Latest Report</div>
            <div class="sep"></div>
            <button class="btn btn-success btn-sm" id="export-report-btn">‚¨á Download Excel</button>
          </div>
          <div class="card-body">
            <div class="report-grid" id="report-grid"></div>
          </div>
        </div>
      </div>

      <!-- Report History -->
      <div class="card">
        <div class="card-header"><div class="card-title">Report History</div></div>
        <div class="card-body" id="report-history">
          <div class="empty-state"><div class="loader"></div></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ===== ISSUE DETAIL MODAL ===== -->
<div class="modal-overlay" id="issue-detail-modal">
  <div class="modal" style="width:700px;">
    <div class="modal-header">
      <div class="modal-title">Issue Detail</div>
      <button class="modal-close" onclick="closeModal('issue-detail-modal')">‚úï</button>
    </div>
    <div class="modal-body" id="issue-detail-body">
      <div class="empty-state"><div class="loader"></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" id="delete-issue-btn">üóë Delete</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('issue-detail-modal')">Close</button>
      <button class="btn btn-primary btn-sm" id="edit-issue-btn">‚úè Edit Status</button>
    </div>
  </div>
</div>

<!-- ===== EDIT ISSUE MODAL ===== -->
<div class="modal-overlay" id="edit-issue-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Update Issue</div>
      <button class="modal-close" onclick="closeModal('edit-issue-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>State</label>
        <select class="form-control" id="edit-state">
          <option>New</option><option>Bug</option><option>Open</option>
          <option>In Progress</option><option>Resolved</option>
        </select>
      </div>
      <div class="form-group">
        <label>Priority</label>
        <select class="form-control" id="edit-priority">
          <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
        </select>
      </div>
      <div class="form-group">
        <label>Assigned To</label>
        <select class="form-control" id="edit-assigned-to">
          <option value="">‚Äî Unassigned ‚Äî</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-issue-modal')">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div id="toast-container"></div>

<script>

// CONFIG

const API = 'http://localhost/issuetracker/api';


// STATE

let currentIssueId = null;
let currentReportId = null;
let allUsers = [];
let charts = {};
let searchTimeout = null;


// INIT

document.addEventListener('DOMContentLoaded', () => {
  loadUsers();
  loadDashboard();
  setTodayDate();

  // Nav items
  document.querySelectorAll('.nav-item[data-view]').forEach(item => {
    item.addEventListener('click', () => navigate(item.dataset.view));
  });

  // Global search
  document.getElementById('global-search').addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (document.getElementById('view-issues').classList.contains('active')) {
        loadIssues();
      }
    }, 350);
  });

  // Drag & drop
  const dz = document.getElementById('drop-zone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) setFile(file);
  });
});


// NAVIGATION

function navigate(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  document.getElementById(`view-${view}`)?.classList.add('active');
  document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');

  const titles = {
    'dashboard': 'Dashboard',
    'issues': 'All Issues',
    'new-issue': 'Log New Issue',
    'import': 'Import CSV',
    'reports': 'Reports'
  };
  document.getElementById('topbar-title').textContent = titles[view] || view;

  if (view === 'issues')   loadIssues();
  if (view === 'reports')  loadReportHistory();
  if (view === 'new-issue') setTodayDate();
}

function openNewIssueModal() {
  navigate('new-issue');
}


// API HELPERS

// 2. Update the function to handle the slash correctly
async function apiFetch(url, opts = {}) {
  try {
    // We add the slash here manually to ensure it's always 'api/filename.php'
    const res = await fetch(`${API}${url}`, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    return await res.json();
  } catch (e) {
    // UPDATED: Removed the "port 5000" message since we are on XAMPP now
    toast('Connection error. Check if XAMPP Apache is running.', 'error');
    throw e;
  }
}


// USERS

async function loadUsers() {
  try {
    const res = await apiFetch('/get_users.php')
    allUsers = res.data || [];
    populateUserSelects();
  } catch { allUsers = []; }
}

function populateUserSelects() {
  const selects = ['ni-issued-by', 'ni-assigned-to', 'import-user', 'edit-assigned-to'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const first = sel.options[0];
    sel.innerHTML = '';
    sel.appendChild(first);
    allUsers.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.name;
      sel.appendChild(opt);
    });
  });
}


// DASHBOARD

async function loadDashboard() {
  try {
    const res = await apiFetch('/get_stats.php');
    const d = res.data;
    if (!d) return;

    document.getElementById('s-total').textContent = d.totalIssues;
    document.getElementById('s-new').textContent   = d.newCount;
    document.getElementById('s-bug').textContent   = d.bugCount;
    document.getElementById('s-open').textContent  = d.openCount;
    document.getElementById('s-prog').textContent  = d.inProgressCount;
    document.getElementById('s-res').textContent   = d.resolvedCount;
    document.getElementById('badge-open').textContent = d.openCount + d.bugCount + d.newCount;

    renderPriorityChart(d.byPriority);
    renderDashboardChart(d.byDashboard);
    loadRecentIssues();
  } catch { }
}

function renderPriorityChart(data) {
  if (charts['priority']) charts['priority'].destroy();
  const ctx = document.getElementById('chart-priority').getContext('2d');
  charts['priority'] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.map(d => d.priority),
      datasets: [{
        data: data.map(d => d.count),
        backgroundColor: ['#d94f4f','#e07b20','#e8a020','#2e9e6b'],
        borderColor: 'rgba(13,27,42,0.8)',
        borderWidth: 2,
        hoverOffset: 6
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#7a96b0', font: { size: 11, family: 'Raleway' }, padding: 14 }
        }
      },
      cutout: '60%',
      maintainAspectRatio: false
    }
  });
}

function renderDashboardChart(data) {
  if (charts['dashboard']) charts['dashboard'].destroy();
  const ctx = document.getElementById('chart-dashboard').getContext('2d');
  charts['dashboard'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => d.dashboard.replace(' Dashboard', '')),
      datasets: [{
        label: 'Issues',
        data: data.map(d => d.count),
        backgroundColor: 'rgba(74,158,206,0.5)',
        borderColor: 'rgba(74,158,206,0.9)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#7a96b0', font: { size: 10 } }, grid: { color: 'rgba(74,158,206,0.07)' } },
        y: { ticks: { color: '#7a96b0', font: { size: 10 } }, grid: { color: 'rgba(74,158,206,0.07)' }, beginAtZero: true }
      },
      maintainAspectRatio: false
    }
  });
}


// RECENT ISSUES (Dashboard)

async function loadRecentIssues() {
  try {
    const res = await apiFetch('/get_issues.php?state=&priority=');
    const issues = (res.data || []).slice(0, 8);
    const tbody = document.getElementById('recent-issues-body');
    tbody.innerHTML = issues.length ? issues.map(issueRow).join('') : emptyRow(8, 'No issues found.');
  } catch (e) {
    console.error(e);
  }
}


// ALL ISSUES

async function loadIssues() {
  const state    = document.getElementById('filter-state')?.value || '';
  const priority = document.getElementById('filter-priority')?.value || '';
  const search   = document.getElementById('global-search')?.value || '';
  const params   = new URLSearchParams();
  if (state)    params.set('state', state);
  if (priority) params.set('priority', priority);
  if (search)   params.set('search', search);

  try {
    const res = await apiFetch(`/get_issues.php${params}`);
    const issues = res.data || [];
    const tbody = document.getElementById('issues-body');
    tbody.innerHTML = issues.length
      ? issues.map(i => issueRow(i, true)).join('')
      : emptyRow(9, 'No issues found. Try adjusting your filters.');
  } catch { }
}

function issueRow(i, showActions = false) {
  return `
  <tr onclick="viewIssue(${i.id})" style="cursor:pointer" class="hover-row"> 
    <td class="td-id">#${i.id}</td>
    <td style="white-space:nowrap;font-size:12px;">${i.dashboard || '‚Äî'}</td>
    ${showActions ? `<td style="font-size:12px;">${i.module || '‚Äî'}</td>` : ''}
    <td class="td-desc">${escHtml(i.description)}</td>
    <td>${stateBadge(i.state)}</td>
    <td>${priBadge(i.priority)}</td>
    <td style="font-size:12px;">${i.issuedByName || '‚Äî'}</td>
    <td class="td-date">${fmtDate(i.dateIdentified)}</td>
    ${showActions ? `<td>
      <div style="display:flex;gap:4px;">
        <button class="btn btn-ghost btn-xs">View</button>
      </div>
    </td>` : '<td></td>'}
  </tr>`;
}



// ISSUE DETAIL

async function viewIssue(id) {
  currentIssueId = id;
  openModal('issue-detail-modal');
  // Clear the old content and show the loader
  document.getElementById('issue-detail-body').innerHTML = '<div class="loader"></div>';

  try {
    const [iRes, cRes, aRes] = await Promise.all([
      apiFetch(`/get_issue_detail.php?id=${id}`), // Ensure the slash is there!
      apiFetch(`/comments.php?issueId=${id}`),
      apiFetch(`/attachments.php?issueId=${id}`)
    ]);

    const issue       = iRes.data;
    const comments    = cRes.data || [];
    const attachments = aRes.data || [];

    document.getElementById('issue-detail-body').innerHTML = `
      <div class="detail-panel">
        <div>
          <h2 style="font-size:15px;font-weight:700;color:var(--text-bright);margin-bottom:14px;line-height:1.4;">${escHtml(issue.description)}</h2>
          <div class="detail-meta">
            <div class="meta-row"><span class="meta-key">State</span><span class="meta-val">${stateBadge(issue.state)}</span></div>
            <div class="meta-row"><span class="meta-key">Priority</span><span class="meta-val">${priBadge(issue.priority)}</span></div>
            <div class="meta-row"><span class="meta-key">Dashboard</span><span class="meta-val">${escHtml(issue.dashboard || '‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Module</span><span class="meta-val">${escHtml(issue.module || '‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Issued By</span><span class="meta-val">${escHtml(issue.issuedByName || '‚Äî')}</span></div>
            <div class="meta-row"><span class="meta-key">Assigned To</span><span class="meta-val">${escHtml(issue.assignedToName || 'Unassigned')}</span></div>
            <div class="meta-row"><span class="meta-key">Date</span><span class="meta-val" style="font-family:'IBM Plex Mono',monospace;font-size:12px;">${fmtDate(issue.dateIdentified)}</span></div>
            <div class="meta-row"><span class="meta-key">Source</span><span class="meta-val" style="font-size:12px;">${issue.source}</span></div>
          </div>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;margin-bottom:10px;">
            Comments (${comments.length})
          </div>
          <div class="comments-section" id="comments-list">
            ${comments.length
              ? comments.map(c => `
                <div class="comment-item">
                  <div><span class="comment-author">${escHtml(c.userName||'User')}</span>
                  <span class="comment-time">${fmtDate(c.createdAt)}</span></div>
                  <div class="comment-text">${escHtml(c.commentText)}</div>
                </div>`).join('')
              : `<div style="color:var(--text-dim);font-size:12px;">No comments yet.</div>`
            }
          </div>
          <div class="comment-input-row" style="margin-top:12px;">
            <select class="form-control" id="comment-user" style="max-width:120px;">
              ${allUsers.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
            </select>
            <textarea id="comment-text" placeholder="Add a comment‚Ä¶"></textarea>
            <button class="btn btn-primary btn-sm" onclick="addComment()" style="align-self:flex-end;">Post</button>
          </div>
        </div>
      </div>
      <div class="attachments-section">
        <div class="attachments-header">üìé Attachments (${attachments.length}/5)</div>
        <div class="attachment-list" id="attachment-list">
          ${attachments.length ? attachments.map(a => `
            <div class="attachment-item" id="att-${a.id}">
              <span class="attachment-icon">${getFileIcon(a.fileType)}</span>
              <span class="attachment-name">${escHtml(a.originalName)}</span>
              <span class="attachment-size">${formatSize(a.fileSize)}</span>
              <a class="attachment-download" href="${API}/attachments.php?issueId=${id}&attachmentId=${a.id}&action=download" target="_blank">‚¨á Download</a>
              <button class="attachment-delete" onclick="deleteAttachment(${a.id}, ${id})">‚úï</button>
            </div>`).join('')
          : `<div style="color:#aaa;font-size:12px;">No attachments yet.</div>`}
        </div>
        <div class="attachment-upload-area">
          <input type="file" id="attachment-file-input" style="display:none;" onchange="uploadAttachment(${id})" />
          <button class="btn-upload" id="attach-upload-btn" onclick="document.getElementById('attachment-file-input').click()" ${attachments.length >= 5 ? 'disabled' : ''}>
            + Attach File
          </button>
          ${attachments.length >= 5 ? '<span class="attachment-count" style="color:#cc0000;">Maximum 5 attachments reached</span>' : `<span class="attachment-count">${5 - attachments.length} remaining</span>`}
        </div>
      </div>`;

    // Wire edit/delete buttons
    document.getElementById('edit-issue-btn').onclick = () => openEditModal(issue);
    document.getElementById('delete-issue-btn').onclick = () => deleteIssue(id);

  } catch { }
}

async function addComment() {
  const userId = parseInt(document.getElementById('comment-user').value);
  const text   = document.getElementById('comment-text').value.trim();
  if (!text) return;

  try {
    await apiFetch(`/comments.php`, { 
      method: 'POST', 
      body: JSON.stringify({
        issueId: currentIssueId,
        userId: userId,
        commentText: text
      }) 
    });
    
    toast('Comment added!', 'success');
    viewIssue(currentIssueId); // Refresh the modal to show the new comment
  } catch (err) {
    toast('Failed to add comment', 'error');
  }
}


// EDIT ISSUE

function openEditModal(issue) {
  document.getElementById('edit-state').value = issue.state;
  document.getElementById('edit-priority').value = issue.priority;
  const sel = document.getElementById('edit-assigned-to');
  sel.value = issue.assignedTo || '';
  openModal('edit-issue-modal');
}

async function saveEdit() {
  const state      = document.getElementById('edit-state').value;
  const priority   = document.getElementById('edit-priority').value;
  const assignedTo = document.getElementById('edit-assigned-to').value;

  const dto = { state, priority };
  if (assignedTo) dto.assignedTo = parseInt(assignedTo);

  await apiFetch(`/update_issue.php/${currentIssueId}`, { method: 'PUT', body: JSON.stringify(dto) });
  closeModal('edit-issue-modal');
  toast('Issue updated!', 'success');
  viewIssue(currentIssueId);
  loadDashboard();
  if (document.getElementById('view-issues').classList.contains('active')) loadIssues();
}


// DELETE ISSUE

async function deleteIssue(id) {
  if (!confirm('Delete this issue? This cannot be undone.')) return;
  await apiFetch(`/delete_issue.php/${id}`, { method: 'DELETE' });
  closeModal('issue-detail-modal');
  toast('Issue deleted.', 'info');
  loadDashboard();
  if (document.getElementById('view-issues').classList.contains('active')) loadIssues();
}


// NEW ISSUE FORM

async function submitNewIssue(e) {
  e.preventDefault();
  const btn = document.getElementById('ni-submit-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loader"></div> Saving‚Ä¶';

  const dto = {
    dashboard:      document.getElementById('ni-dashboard').value.trim() || null,
    module:         document.getElementById('ni-module').value.trim() || null,
    description:    document.getElementById('ni-desc').value.trim(),
    state:          document.getElementById('ni-state').value,
    priority:       document.getElementById('ni-priority').value,
    issuedBy:       parseInt(document.getElementById('ni-issued-by').value) || null,
    assignedTo:     parseInt(document.getElementById('ni-assigned-to').value) || null,
    dateIdentified: document.getElementById('ni-date').value
  };

  try {
    await apiFetch('/create_issue.php', { method: 'POST', body: JSON.stringify(dto) });
    toast('Issue created successfully!', 'success');
    document.getElementById('new-issue-form').reset();
    setTodayDate();
    loadDashboard();
    navigate('issues');
  } catch {
    toast('Failed to create issue.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Issue';
  }
}

function setTodayDate() {
  const d = document.getElementById('ni-date');
  if (d) d.value = new Date().toISOString().split('T')[0];
}

// ===========================
// IMPORT CSV
// ===========================
let selectedFile = null;

function handleFileSelect(e) {
  setFile(e.target.files[0]);
}

function setFile(file) {
  selectedFile = file;
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('file-size').textContent = (file.size / 1024).toFixed(1) + ' KB';
  document.getElementById('file-preview').style.display = '';
}

function clearFile() {
  selectedFile = null;
  document.getElementById('file-preview').style.display = 'none';
  document.getElementById('csv-file').value = '';
}

async function doImport() {
  if (!selectedFile) { toast('Please select a CSV file.', 'error'); return; }

  const userId = document.getElementById('import-user').value;
  const btn    = document.getElementById('import-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loader"></div> Importing‚Ä¶';

  const form = new FormData();
  form.append('file', selectedFile);
  if (userId) form.append('importedBy', userId);

  try {
    const res = await fetch(`${API}/import/csv`, { method: 'POST', body: form });
    const data = await res.json();
    const result = document.getElementById('import-result');
    result.style.display = '';

    if (data.success) {
      result.innerHTML = `
        <div style="background:rgba(46,158,107,0.1);border:1px solid rgba(46,158,107,0.3);border-radius:8px;padding:14px 18px;">
          <div style="font-weight:700;color:var(--success);margin-bottom:6px;">‚úÖ ${data.message}</div>
          ${data.data?.errors?.length ? `<div style="font-size:11px;color:var(--text-dim);">${data.data.errors.slice(0,5).map(e => `<div>‚ö† ${escHtml(e)}</div>`).join('')}</div>` : ''}
        </div>`;
      toast(data.message, 'success');
      clearFile();
      loadDashboard();
    } else {
      result.innerHTML = `<div style="background:rgba(217,79,79,0.1);border:1px solid rgba(217,79,79,0.3);border-radius:8px;padding:14px 18px;color:var(--danger);">‚ùå ${escHtml(data.message || 'Import failed.')}</div>`;
      toast('Import failed.', 'error');
    }
  } catch {
    toast('Could not connect to API.', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üì• Import File';
  }
}

// ===========================
// REPORTS
// ===========================
async function generateReport() {
  const dto = {
    dateRange:    document.getElementById('rpt-date-range').value,
    statusFilter: document.getElementById('rpt-status-filter').value
  };

  try {
  const res = await apiFetch('/create_report.php', { method: 'POST', body: JSON.stringify(dto) });
    const r   = res.data;
    currentReportId = r.id;

    const grid = document.getElementById('report-grid');
    grid.innerHTML = [
      ['Total Issues', r.totalIssues, 'üì¶'],
      ['New', r.newCount, 'üÜï'],
      ['Bugs', r.bugCount, 'üêõ'],
      ['Open', r.openCount, 'üìÇ'],
      ['In Progress', r.inProgressCount, '‚öô'],
      ['Resolved', r.resolvedCount, '‚úÖ']
    ].map(([label, val, icon]) => `
      <div class="report-stat-box">
        <div><div class="rs-label">${label}</div><div class="rs-val">${val}</div></div>
        <div style="font-size:28px;opacity:0.3;">${icon}</div>
      </div>`).join('');

    document.getElementById('latest-report-section').style.display = '';
    document.getElementById('export-report-btn').onclick = () => downloadReportExcel(r.id);
    toast('Report generated!', 'success');
    loadReportHistory();
  } catch { }
}

async function loadReportHistory() {
  try {
    const res  = await apiFetch('/get_reports.php');
    const list = res.data || [];
    const container = document.getElementById('report-history');

    container.innerHTML = list.length
      ? list.map(r => `
        <div class="report-history-item">
          <div class="rh-icon">üìã</div>
          <div class="rh-info">
            <div class="rh-title">${r.date_range || r.dateRange || 'Custom'} ‚Äî ${r.status_filter || r.statusFilter}</div>
            <div class="rh-sub">
              ${r.total_issues || r.totalIssues} issues ¬∑ ${fmtDateTime(r.generated_at || r.generatedAt)}
            </div>
          </div>
          <button class="btn btn-success btn-xs" onclick="downloadReportExcel(${r.id})">‚¨á Excel</button>
        </div>`).join('')
      : `<div class="empty-state">
          <div class="es-icon">üìã</div>
          <div class="es-title">No reports yet</div>
          <div class="es-sub">Generate your first report above.</div>
        </div>`; // Fixed the missing colon here
  } catch (e) {
    console.error("Failed to load report history:", e);
  }
}

function downloadReportExcel(id) {
  window.open(`${API}/download_report.php?id=${id}`, '_blank');
}

function exportIssues() {
  const state    = document.getElementById('filter-state')?.value || '';
  const priority = document.getElementById('filter-priority')?.value || '';
  const params   = new URLSearchParams();
  if (state)    params.set('state', state);
  if (priority) params.set('priority', priority);
  
  // Point to a PHP script instead of /reports/export-issues
  window.open(`${API}/export_issues_excel.php?${params}`, '_blank');
}


// ===========================
// MODAL HELPERS
// ===========================
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ===========================
// TOAST
// ===========================
function toast(message, type = 'info') {
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚Ñπ' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${icons[type]}</span><span>${escHtml(message)}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3800);
}

// ===========================
// FORMATTING HELPERS
// ===========================
function stateBadge(state) {
  const map = {
    'New': 'badge-new', 'Bug': 'badge-bug', 'Open': 'badge-open',
    'In Progress': 'badge-inprogress', 'Resolved': 'badge-resolved'
  };
  return `<span class="badge ${map[state] || 'badge-new'}">${state}</span>`;
}

function priBadge(p) {
  const map = { 'Critical': 'pri-critical', 'High': 'pri-high', 'Medium': 'pri-medium', 'Low': 'pri-low' };
  return `<span class="pri-badge ${map[p] || 'pri-medium'}">${p}</span>`;
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-PH', { year: 'numeric', month: 'short', day: '2-digit' });
}

function fmtDateTime(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleString('en-PH', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function emptyRow(cols, msg) {
  return `<tr><td colspan="${cols}"><div class="empty-state"><div class="es-icon">üîç</div><div class="es-title">${msg}</div></div></td></tr>`;
}

function getFileIcon(fileType) {
  if (!fileType) return 'üìÑ';
  if (fileType.startsWith('image/')) return 'üñºÔ∏è';
  if (fileType === 'application/pdf') return 'üìï';
  if (fileType.includes('word')) return 'üìù';
  if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
  return 'üìÑ';
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function uploadAttachment(issueId) {
  const input = document.getElementById('attachment-file-input');
  const file = input.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch(`${API}/attachments.php?issueId=${issueId}`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (data.success) {
      toast('File attached successfully!', 'success');
      await refreshAttachments(issueId);
    } else {
      toast(data.message || 'Upload failed.', 'error');
    }
  } catch {
    toast('Upload failed.', 'error');
  }
  input.value = '';
}

async function refreshAttachments(issueId) {
  const aRes = await apiFetch(`/attachments.php?issueId=${issueId}`);
  const attachments = aRes.data || [];

  const list = document.getElementById('attachment-list');
  if (!list) return;

  list.innerHTML = attachments.length ? attachments.map(a => `
    <div class="attachment-item" id="att-${a.id}">
      <span class="attachment-icon">${getFileIcon(a.fileType)}</span>
      <span class="attachment-name">${escHtml(a.originalName)}</span>
      <span class="attachment-size">${formatSize(a.fileSize)}</span>
      <a class="attachment-download" href="${API}/download_attachment.php?id=${a.id}" target="_blank">‚¨á Download</a>
      <button class="attachment-delete" onclick="deleteAttachment(${a.id}, ${issueId})">‚úï</button>
    </div>`).join('')
  : `<div style="color:#aaa;font-size:12px;">No attachments yet.</div>`;

  const uploadBtn = document.getElementById('attach-upload-btn');
  if (uploadBtn) uploadBtn.disabled = attachments.length >= 5;

  const countSpan = document.querySelector('.attachment-count');
  if (countSpan) countSpan.textContent = attachments.length >= 5
    ? 'Maximum 5 attachments reached'
    : `${5 - attachments.length} remaining`;

  const header = document.querySelector('.attachments-header');
  if (header) header.textContent = `üìé Attachments (${attachments.length}/5)`;
}

async function deleteAttachment(attachmentId, issueId) {
  if (!confirm('Remove this attachment?')) return;
  try {
    const res = await fetch(`${API}/delete_attachment.php?issueId=${issueId}&attachmentId=${attachmentId}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      toast('Attachment removed.', 'success');
      await refreshAttachments(issueId);
    }
  } catch {
    toast('Failed to remove attachment.', 'error');
  }
}

</script>
</body>
</html>